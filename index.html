<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Presencia - Sistema Profesional V31 GPS Supabase</title>
    <!--
    ========================================
    VERSI√ìN 31 - SUPABASE 100% INTEGRADO
    ========================================
    
    SISTEMA COMPLETO FUNCIONANDO CON SUPABASE:
    1. ‚úÖ Trabajadores cargados desde Supabase (tabla workers)
    2. ‚úÖ Fichajes guardados en Supabase (tabla clockings)
    3. ‚úÖ Obras con GPS en Supabase (tabla worksites)
    4. ‚úÖ FONTOURA con coordenadas correctas: 41.653224, -8.691008
    5. ‚úÖ Validaci√≥n GPS en tiempo real
    6. ‚úÖ Fallback a localStorage si Supabase falla (resiliente)
    
    FUNCIONALIDAD COMPLETA:
    - Login Trabajador/Admin/Gerente
    - Panel de fichaje con facial recognition + GPS
    - Dashboard completo con datos de Supabase
    - Gesti√≥n de obras y trabajadores
    - Sincronizaci√≥n autom√°tica de trabajadores a Supabase
    
    CREDENCIALES:
    - Trabajador: adolfo.silva / 1234
    - Admin: admin / Admin@2025!Segura
    - Gerencia: gerencia / Gerencia@2025!Segura
    
    ESTADO: ‚úÖ LISTO PARA PRODUCCI√ìN
    ========================================
    -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .app-header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 700;
            color: #2563eb;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .user-badge {
            background: #2563eb;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1e40af;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-large {
            padding: 25px 35px;
            font-size: 18px;
            width: 100%;
            margin: 15px 0;
        }

        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 450px;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            color: #2563eb;
            margin-bottom: 10px;
            text-align: center;
        }

        .login-subtitle {
            text-align: center;
            color: #6b7280;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #2563eb;
        }

        .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .form-select:focus {
            outline: none;
            border-color: #2563eb;
        }

        .dashboard {
            display: grid;
            gap: 20px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f3f4f6;
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
        }

        /* PANEL DE MONITOREO MEJORADO */
        .monitor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
            padding: 15px 0;
        }

        .worker-monitor-card {
            background: white;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            text-align: center;
            border: 3px solid;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            min-height: 200px;
        }

        .worker-monitor-card.status-red {
            border-color: #dc3545;
            background: linear-gradient(to bottom, #ffffff 0%, #fef2f2 100%);
        }

        .worker-monitor-card.status-green {
            border-color: #28a745;
            background: linear-gradient(to bottom, #ffffff 0%, #f0fdf4 100%);
        }

        .worker-monitor-card.status-orange {
            border-color: #ffc107;
            background: linear-gradient(to bottom, #ffffff 0%, #fefce8 100%);
        }

        .worker-monitor-card.status-grey {
            border-color: #6c757d;
            background: linear-gradient(to bottom, #ffffff 0%, #f8f9fa 100%);
        }

        .worker-monitor-photo {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 8px;
            border: 3px solid #e5e7eb;
            display: block;
            background: #f3f4f6 url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23d1d5db"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>') center/60% no-repeat;
        }

        .status-red .worker-monitor-photo {
            border-color: #e5e7eb;
        }

        .status-green .worker-monitor-photo {
            border-color: #e5e7eb;
        }

        .status-orange .worker-monitor-photo {
            border-color: #e5e7eb;
        }

        .status-grey .worker-monitor-photo {
            border-color: #e5e7eb;
        }

        .worker-monitor-name {
            font-size: 12px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 3px;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .worker-monitor-id {
            font-size: 10px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .status-button {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            border: none;
            cursor: default;
            margin-top: auto;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-red .status-button {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .status-green .status-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .status-orange .status-button {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .work-details {
            font-size: 9px;
            color: #065f46;
            margin-top: 4px;
            line-height: 1.3;
        }

        .absence-reason {
            font-size: 9px;
            color: #92400e;
            margin-top: 4px;
            font-style: italic;
            line-height: 1.3;
        }

        /* Resto del CSS de la versi√≥n anterior */
        .clock-in-section {
            text-align: center;
            padding: 20px;
        }

        .big-clock {
            font-size: 48px;
            font-weight: 700;
            color: #2563eb;
            margin-bottom: 10px;
        }

        .current-date {
            font-size: 18px;
            color: #6b7280;
            margin-bottom: 30px;
        }

        .worker-info-box {
            background: #f0fdf4;
            border: 2px solid #10b981;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .worker-info-box h3 {
            color: #065f46;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .worker-info-box p {
            color: #047857;
            font-size: 16px;
            margin: 5px 0;
        }

        .security-warning {
            background: #fef2f2;
            border: 2px solid #ef4444;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .security-warning h3 {
            color: #991b1b;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .security-warning p {
            color: #dc2626;
            font-size: 14px;
            margin: 5px 0;
        }

        .clock-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .clock-btn {
            padding: 40px 30px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 20px;
            font-weight: 700;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .clock-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .clock-btn-in {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .clock-btn-in:hover:not(:disabled) {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .clock-btn-out {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .clock-btn-out:hover:not(:disabled) {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
        }

        .clock-btn-icon {
            font-size: 36px;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #d1fae5;
            color: #065f46;
        }

        .status-inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-working {
            background: #dbeafe;
            color: #1e40af;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
            white-space: nowrap;
        }

        td {
            color: #6b7280;
            font-size: 14px;
        }

        tr:hover {
            background: #f9fafb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .location-info {
            background: #f0fdf4;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #065f46;
            font-size: 14px;
        }

        .location-error {
            background: #fef2f2;
            color: #991b1b;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 28px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            color: #ffffff;
            position: relative;
            transition: all 0.3s;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tab:hover {
            color: #e0e7ff;
            background: rgba(255, 255, 255, 0.1);
        }

        .tab.active {
            color: #ffffff;
            background: rgba(255, 255, 255, 0.15);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #ffffff;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .camera-preview {
            width: 100%;
            max-width: 400px;
            margin: 15px auto;
            border-radius: 8px;
            overflow: hidden;
        }

        .camera-preview video,
        .camera-preview img {
            width: 100%;
            display: block;
        }

        .photo-required {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: #92400e;
            font-weight: 600;
        }

        .demo-credentials {
            background: #fef3c7;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 13px;
            color: #92400e;
        }

        .qr-display {
            max-width: 300px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 12px;
            text-align: center;
        }

        #qr-reader {
            max-width: 500px;
            margin: 20px auto;
        }

        .instruction-box {
            background: #eff6ff;
            border: 2px solid #3b82f6;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .instruction-box h3 {
            color: #1e40af;
            margin-bottom: 15px;
        }

        .instruction-box ol {
            color: #1e40af;
            margin-left: 20px;
        }

        .instruction-box li {
            margin: 10px 0;
        }

        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .qr-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            text-align: center;
            max-width: 250px;
            margin: 0 auto;
        }

        .qr-code-container {
            margin: 10px 0;
            padding: 10px;
        }

        .qr-code-container canvas {
            max-width: 150px !important;
            height: auto !important;
        }

        .qr-worker-name {
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .qr-worker-id {
            font-size: 11px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        /* Estilos para impresi√≥n tipo carnet */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .qr-grid, .qr-grid * {
                visibility: visible;
            }
            
            .qr-grid {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 10mm !important;
                padding: 10mm !important;
            }
            
            .qr-card {
                break-inside: avoid;
                page-break-inside: avoid;
                border: 2px solid #000;
                padding: 8mm;
                max-width: none;
                width: 85mm;
                height: 54mm; /* Tama√±o carnet est√°ndar */
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }
            
            .qr-code-container canvas {
                max-width: 100px !important;
                width: 100px !important;
                height: 100px !important;
            }
            
            .qr-worker-name {
                font-size: 11px;
            }
            
            .qr-worker-id {
                font-size: 9px;
            }
            
            .card-header, .btn, button {
                display: none !important;
            }
        }

        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .clock-buttons {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .filters {
                flex-direction: column;
            }

            .filter-group {
                width: 100%;
            }

            .big-clock {
                font-size: 36px;
            }

            .monitor-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        // Datos de la empresa - TODOS LOS 33 TRABAJADORES
        const COMPANY_DATA = {
            obras: [
                {"id": "OB001", "cliente": "TORRES IDILICAS", "nombre_obra": "FONTOURA", "lat": 41.653224, "lng": -8.691008, "radius": 100},
                {"id": "OB002", "cliente": "BYB", "nombre_obra": "OIA VIGO", "lat": null, "lng": null, "radius": 100},
                {"id": "OB003", "cliente": "BYB", "nombre_obra": "VIRXINIA PEREIRA", "lat": null, "lng": null, "radius": 100},
                {"id": "OB004", "cliente": "VISTA AL MARCO S.L.U.", "nombre_obra": "CALLE PRINCIPE 59", "lat": null, "lng": null, "radius": 100},
                {"id": "OB005", "cliente": "BYB", "nombre_obra": "VALDECORVOS", "lat": null, "lng": null, "radius": 100},
                {"id": "OB006", "cliente": "ONE OCEAN", "nombre_obra": "DESIDEIRO PENAS", "lat": null, "lng": null, "radius": 100},
                {"id": "OB007", "cliente": "ONE OCEAN", "nombre_obra": "AREACOVA 62", "lat": null, "lng": null, "radius": 100},
                {"id": "OB008", "cliente": "HERCULINA 123", "nombre_obra": "SANJURJO BADIA", "lat": null, "lng": null, "radius": 100},
                {"id": "OB009", "cliente": "FULCRUM", "nombre_obra": "MOA√ëA", "lat": null, "lng": null, "radius": 100},
                {"id": "OB010", "cliente": "HERCULINA 123", "nombre_obra": "PAREDES CONDE CHANS", "lat": null, "lng": null, "radius": 100},
                {"id": "OB011", "cliente": "HERCULINA 123", "nombre_obra": "CONDE CHANS", "lat": null, "lng": null, "radius": 100},
                {"id": "OB012", "cliente": "BYB", "nombre_obra": "PADRE FEIJOO 39", "lat": null, "lng": null, "radius": 100},
                {"id": "OB013", "cliente": "EDAR OURENSE", "nombre_obra": "EDAR OURENSE", "lat": null, "lng": null, "radius": 100},
                {"id": "OB014", "cliente": "HOME SANTANDER", "nombre_obra": "HOME SANTANDER", "lat": null, "lng": null, "radius": 100},
                {"id": "OB015", "cliente": "HOME SANTANDER", "nombre_obra": "OBRA CORU√ëA", "lat": null, "lng": null, "radius": 100},
                {"id": "OB016", "cliente": "HOME SANTANDER", "nombre_obra": "LAS PALMAS", "lat": null, "lng": null, "radius": 100},
                {"id": "OB017", "cliente": "SANTIAGO", "nombre_obra": "PEREGRINA 16", "lat": null, "lng": null, "radius": 100},
                {"id": "OB018", "cliente": "SANTIAGO", "nombre_obra": "CARDENAL MU√ëOZ", "lat": null, "lng": null, "radius": 100},
                {"id": "OB019", "cliente": "ROOFTOP", "nombre_obra": "PRINCIPE 59 ROOFTOP", "lat": null, "lng": null, "radius": 100},
                {"id": "OB020", "cliente": "BYB", "nombre_obra": "ALFONSO MOLINA", "lat": null, "lng": null, "radius": 100}
            ],
            trabajadores: [
                {"id": 11, "nombre": "ADOLFO DA SILVA CARVALHO", "usuario": "adolfo.silva", "password": "1234"},
                {"id": 228, "nombre": "ALEXANDRE HENRIQUE DE PAULA", "usuario": "alexandre.paula", "password": "1234"},
                {"id": 372, "nombre": "ALFONSO DE JESUS RIVAS GUEVARA", "usuario": "alfonso.rivas", "password": "1234"},
                {"id": 317, "nombre": "ANDRISSON SILVA DE MELO", "usuario": "andrisson.melo", "password": "1234"},
                {"id": 356, "nombre": "CARLOS ALBERTO SARAIVA DE ABREU", "usuario": "carlos.saraiva", "password": "1234"},
                {"id": 362, "nombre": "CARLOS MAGNO VIEGAS", "usuario": "carlos.viegas", "password": "1234"},
                {"id": 297, "nombre": "EDINHO BEZERRA DO NASCIMENTO", "usuario": "edinho.bezerra", "password": "1234"},
                {"id": 357, "nombre": "FELIPE BITENCOURT", "usuario": "felipe.bitencourt", "password": "1234"},
                {"id": 298, "nombre": "FREDDY GIOVANNI URIBE NAVAS", "usuario": "freddy.uribe", "password": "1234"},
                {"id": 300, "nombre": "GEAN DOS SANTOS COSTA", "usuario": "gean.santos", "password": "1234"},
                {"id": 303, "nombre": "GIOVANE LUIZ VIEIRA", "usuario": "giovane.vieira", "password": "1234"},
                {"id": 373, "nombre": "ISAAC MAURO MONJE RAMIREZ", "usuario": "isaac.monje", "password": "1234"},
                {"id": 375, "nombre": "IVAN DARIO VARGAS MARTINEZ", "usuario": "ivan.vargas", "password": "1234"},
                {"id": 369, "nombre": "IZAIAS SANTOS SOUZA", "usuario": "izaias.souza", "password": "1234"},
                {"id": 367, "nombre": "JACKSON MIGUEL SOTOMAYOR VACA", "usuario": "jackson.sotomayor", "password": "1234"},
                {"id": 306, "nombre": "JACKSON SIQUEIRA SANTOS", "usuario": "jackson.siqueira", "password": "1234"},
                {"id": 370, "nombre": "JAVIER OMAR PARDO MARIN", "usuario": "javier.pardo", "password": "1234"},
                {"id": 318, "nombre": "JEFERSON BRAGUINI", "usuario": "jeferson.braguini", "password": "1234"},
                {"id": 308, "nombre": "JHONATAN NOEL SANCHEZ SILVA", "usuario": "jhonatan.sanchez", "password": "1234"},
                {"id": 371, "nombre": "JONATHAN DANILO PUENTE VELASQUEZ", "usuario": "jonathan.puente", "password": "1234"},
                {"id": 366, "nombre": "JOSE FERNANDO HERNANDEZ BARRETO", "usuario": "jose.hernandez", "password": "1234"},
                {"id": 313, "nombre": "JULIO CESAR CRUZ SALCEDO", "usuario": "julio.cruz", "password": "1234"},
                {"id": 368, "nombre": "LUIS MIGUEL GARCIA AGUILERA", "usuario": "luis.garcia", "password": "1234"},
                {"id": 365, "nombre": "MARCO ANTONIO LOPEZ CORRALES", "usuario": "marco.lopez", "password": "1234"},
                {"id": 364, "nombre": "PABLO ALEJANDRO RAMIREZ CASTRO", "usuario": "pablo.ramirez", "password": "1234"},
                {"id": 360, "nombre": "REGULO ALFONSO HENRIQUE DA ENCARNACAO", "usuario": "regulo.henrique", "password": "1234"},
                {"id": 315, "nombre": "RUBEN DARIO MORA SANDOVAL", "usuario": "ruben.mora", "password": "1234"},
                {"id": 374, "nombre": "SERGIO WILLIAM AGUIRRE GARCIA", "usuario": "sergio.aguirre", "password": "1234"},
                {"id": 361, "nombre": "VALDEIR BONFIM REIS", "usuario": "valdeir.reis", "password": "1234"},
                {"id": 316, "nombre": "VALDIR FERREIRA DOS SANTOS", "usuario": "valdir.santos", "password": "1234"},
                {"id": 355, "nombre": "VANDERLEI FEITOZA DE OLIVEIRA", "usuario": "vanderlei.oliveira", "password": "1234"},
                {"id": 376, "nombre": "WADIS JOSUE RAMOS GUZMAN", "usuario": "wadis.ramos", "password": "1234"},
                {"id": 359, "nombre": "WILLIAN FELIPE DOS SANTOS", "usuario": "willian.santos", "password": "1234"}
            ]
        };

        const ADMIN_USER = {
            id: 'admin',
            usuario: 'admin',
            password: 'Admin@2025!Segura',
            role: 'admin',
            name: 'Administrador'
        };

        const GERENCIA_USER = {
            id: 'gerencia',
            usuario: 'gerencia',
            password: 'Gerencia@2025!Segura',
            role: 'admin',
            name: 'Gerencia Principal'
        };

        // Funci√≥n para sincronizar trabajadores a Supabase (ejecutar una sola vez)
        async function syncWorkersToSupabase() {
            try {
                console.log('üîÑ Verificando trabajadores en Supabase...');
                
                // Verificar si ya existen trabajadores
                
                if (!existing.data || existing.data.length === 0) {
                    console.log('üìù No hay trabajadores, iniciando sincronizaci√≥n...');
                    
                    // Insertar todos los trabajadores
                    const workersToInsert = COMPANY_DATA.trabajadores.map(t => ({
                        id: t.id,
                        nombre: t.nombre,
                        usuario: t.usuario,
                        password: t.password,
                        role: 'worker',
                        obra_asig: 'FONTOURA'
                    }));
                    
                    // Insertar uno por uno para evitar conflictos
                    let insertados = 0;
                    for (const worker of workersToInsert) {
                        try {
                           await supabase.from('workers').insert(worker);
~
                            insertados++;
                            if (insertados % 5 === 0) {
                                console.log(`‚úÖ Insertados ${insertados}/${workersToInsert.length} trabajadores`);
                            }
                        } catch (err) {
                            console.log(`‚ö†Ô∏è Trabajador ${worker.usuario} ya existe, omitiendo...`);
                        }
                    }
                    
                    console.log(`‚úÖ Sincronizaci√≥n completada: ${insertados} trabajadores`);
                } else {
                    console.log(`‚ÑπÔ∏è Ya hay ${existing.data.length} trabajadores en Supabase, no es necesario sincronizar`);
                }
            } catch (error) {
                console.error('‚ùå Error sincronizando:', error);
            }
        }

        // Ejecutar sincronizaci√≥n al cargar (solo si es necesario)
        if (typeof window !== 'undefined') {
            window.addEventListener('load', () => {
                // Siempre verificar, pero solo sincronizar si est√° vac√≠o
                setTimeout(() => {
                    syncWorkersToSupabase();
                }, 2000); // Esperar 2 segundos para que Supabase est√© listo
            });
        }

        // Configuraci√≥n GPS por defecto
        const DEFAULT_GPS_CONFIG = {
            enabled: false,  // Desactivado para pruebas en PC (IP geolocation imprecisa)
            mode: 'alert', // 'alert' o 'block'
            defaultRadius: 100,
            showInMonitor: true
        };

        // Funci√≥n para geocodificar direcci√≥n usando Nominatim (OpenStreetMap)
        async function geocodeAddress(address) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`,
                    {
                        headers: {
                            'User-Agent': 'ControlPresencia/1.0'
                        }
                    }
                );
                const data = await response.json();
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon),
                        display_name: data[0].display_name
                    };
                }
                return null;
            } catch (error) {
                console.error('Error geocodificando:', error);
                return null;
            }
        }

        // Funci√≥n para calcular distancia entre dos puntos GPS (en metros)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Radio de la Tierra en metros
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                    Math.cos(œÜ1) * Math.cos(œÜ2) *
                    Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Distancia en metros
        }

        // Componente de Gesti√≥n GPS y Obras
        // Componente de Gesti√≥n GPS y Obras
        const GPSManager = ({ showNotification }) => {
            const [gpsConfig, setGpsConfig] = useState(DEFAULT_GPS_CONFIG);
            const [obras, setObras] = useState([]);
            const [editingObra, setEditingObra] = useState(null);
            const [showModal, setShowModal] = useState(false);
            const [searchAddress, setSearchAddress] = useState('');
            const [isGeocoding, setIsGeocoding] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');

            // Cargar obras y configuraci√≥n al montar
            useEffect(() => {
                loadObras();
                loadGPSConfig();
            }, []);

            const loadObras = async () => {
                try {
                    console.log('üìç Cargando obras desde Supabase...');
                    
                    // Cargar desde Supabase
                    const result = await supabase.from('worksites').select('*');
                    
                    if (result.data && result.data.length > 0) {
                        // Convertir formato Supabase a formato del sistema
                        const obrasFromSupabase = result.data.map(w => ({
                            id: w.id.toString(),
                            cliente: w.direccion || 'Sin cliente',
                            nombre_obra: w.nombre,
                            lat: parseFloat(w.latitude),
                            lng: parseFloat(w.longitude),
                            radius: w.radio_metros || 100
                        }));
                        
                        console.log('‚úÖ Obras cargadas desde Supabase:', obrasFromSupabase.length);
                        setObras(obrasFromSupabase);
                        
                        // Actualizar COMPANY_DATA para que trabajadores vean las obras actualizadas
                        COMPANY_DATA.obras = COMPANY_DATA.obras.map(obra => {
                            const supabaseObra = obrasFromSupabase.find(o => o.nombre_obra === obra.nombre_obra);
                            if (supabaseObra) {
                                return { ...obra, ...supabaseObra };
                            }
                            return obra;
                        });
                        
                        // Agregar obras nuevas que est√©n en Supabase pero no en COMPANY_DATA
                        obrasFromSupabase.forEach(supabaseObra => {
                            const exists = COMPANY_DATA.obras.find(o => o.nombre_obra === supabaseObra.nombre_obra);
                            if (!exists) {
                                COMPANY_DATA.obras.push(supabaseObra);
                            }
                        });
                        
                        console.log('‚úÖ COMPANY_DATA actualizado con obras de Supabase');
                        
                        // Guardar en localStorage como cache
                        localStorage.setItem('gps_obras', JSON.stringify(obrasFromSupabase));
                        
                        return;
                    }
                    
                    console.log('‚ö†Ô∏è No hay obras en Supabase, usando datos locales');
                    
                } catch (error) {
                    console.error('‚ùå Error cargando desde Supabase:', error);
                }
                
                // Fallback: Usar COMPANY_DATA solo si Supabase falla
                console.log('üìã Usando obras de COMPANY_DATA como fallback');
                localStorage.setItem('gps_obras', JSON.stringify(COMPANY_DATA.obras));
                setObras(COMPANY_DATA.obras);
            };

            const loadGPSConfig = () => {
                const savedConfig = localStorage.getItem('gps_config');
                if (savedConfig) {
                    setGpsConfig(JSON.parse(savedConfig));
                } else {
                    localStorage.setItem('gps_config', JSON.stringify(DEFAULT_GPS_CONFIG));
                }
            };

            const saveObras = (newObras) => {
                localStorage.setItem('gps_obras', JSON.stringify(newObras));
                setObras(newObras);
                // Actualizar tambi√©n COMPANY_DATA
                COMPANY_DATA.obras = newObras;
            };

            const saveGPSConfig = (newConfig) => {
                localStorage.setItem('gps_config', JSON.stringify(newConfig));
                setGpsConfig(newConfig);
            };

            const handleSearchAddress = async () => {
                if (!searchAddress.trim()) {
                    showNotification('Por favor introduce una direcci√≥n', 'error');
                    return;
                }

                setIsGeocoding(true);
                showNotification('üîç Buscando coordenadas...', 'info');

                const result = await geocodeAddress(searchAddress);
                
                setIsGeocoding(false);

                if (result) {
                    setEditingObra({
                        ...editingObra,
                        lat: result.lat,
                        lng: result.lng
                    });
                    showNotification(
                        `‚úÖ Coordenadas encontradas:\n${result.display_name}`,
                        'success'
                    );
                } else {
                    showNotification(
                        '‚ùå No se encontraron coordenadas\n\nIntenta con:\n‚Ä¢ Direcci√≥n completa con ciudad\n‚Ä¢ Nombre del lugar + ciudad\nEjemplo: "Calle Pr√≠ncipe 59, Vigo"',
                        'error'
                    );
                }
            };

            const handleEditObra = (obra) => {
                setEditingObra({...obra});
                setSearchAddress('');
                setShowModal(true);
            };

            const handleNewObra = () => {
                // Generar ID √∫nico
                const newId = 'OB' + String(obras.length + 1).padStart(3, '0');
                
                setEditingObra({
                    id: newId,
                    nombre_obra: '',
                    cliente: '',
                    direccion: '',
                    lat: null,
                    lng: null,
                    radius: gpsConfig.defaultRadius,
                    isNew: true
                });
                setSearchAddress('');
                setShowModal(true);
            };

            const handleSaveObra = () => {
                // Validar campos obligatorios
                if (!editingObra.nombre_obra || !editingObra.nombre_obra.trim()) {
                    showNotification('Debes ingresar el nombre de la obra', 'error');
                    return;
                }
                
                if (!editingObra.cliente || !editingObra.cliente.trim()) {
                    showNotification('Debes ingresar el cliente', 'error');
                    return;
                }
                
                if (!editingObra.lat || !editingObra.lng) {
                    showNotification('Debes configurar las coordenadas GPS', 'error');
                    return;
                }

                let updatedObras;
                
                if (editingObra.isNew) {
                    // Crear nueva obra
                    const newObra = {...editingObra};
                    delete newObra.isNew;
                    updatedObras = [...obras, newObra];
                    showNotification(`Obra "${newObra.nombre_obra}" creada correctamente`, 'success');
                } else {
                    // Actualizar obra existente
                    updatedObras = obras.map(o => 
                        o.id === editingObra.id ? editingObra : o
                    );
                    showNotification(`Obra "${editingObra.nombre_obra}" actualizada`, 'success');
                }

                saveObras(updatedObras);
                setShowModal(false);
                setEditingObra(null);
            };

            const handleDeleteObra = (obra) => {
                // Confirmar eliminaci√≥n
                if (!confirm(
                    `¬øEliminar esta obra?\n\n` +
                    `Obra: ${obra.nombre_obra}\n` +
                    `Cliente: ${obra.cliente}\n\n` +
                    `‚ö†Ô∏è ADVERTENCIA:\n` +
                    `‚Ä¢ Los fichajes hist√≥ricos NO se eliminar√°n\n` +
                    `‚Ä¢ Solo se eliminar√° de la lista de obras activas\n` +
                    `‚Ä¢ Esta acci√≥n no se puede deshacer\n\n` +
                    `¬øContinuar?`
                )) {
                    return;
                }

                // Eliminar obra
                const updatedObras = obras.filter(o => o.id !== obra.id);
                saveObras(updatedObras);
                
                showNotification(
                    `Obra "${obra.nombre_obra}" eliminada correctamente\n\n` +
                    `Los fichajes hist√≥ricos se mantienen intactos`,
                    'success'
                );
            };

            const handleGetCurrentLocation = () => {
                if (!navigator.geolocation) {
                    showNotification('‚ùå Tu navegador no soporta geolocalizaci√≥n', 'error');
                    return;
                }

                showNotification('üìç Obteniendo tu ubicaci√≥n actual...', 'info');

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        setEditingObra({
                            ...editingObra,
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        });
                        showNotification(
                            `‚úÖ Ubicaci√≥n obtenida!\n\nLat: ${position.coords.latitude.toFixed(6)}\nLng: ${position.coords.longitude.toFixed(6)}\n\nPrecisi√≥n: ¬±${position.coords.accuracy.toFixed(0)}m`,
                            'success'
                        );
                    },
                    (error) => {
                        showNotification(
                            '‚ùå Error obteniendo ubicaci√≥n\n\n' +
                            'Verifica:\n‚Ä¢ Permisos de ubicaci√≥n activados\n‚Ä¢ GPS/WiFi encendido',
                            'error'
                        );
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            };

            const filteredObras = obras.filter(obra => 
                obra.nombre_obra.toLowerCase().includes(searchTerm.toLowerCase()) ||
                obra.cliente.toLowerCase().includes(searchTerm.toLowerCase()) ||
                obra.id.toLowerCase().includes(searchTerm.toLowerCase())
            );

            return (
                <div className="card">
                    <div className="card-header">
                        <h2 className="card-title">‚öôÔ∏è Configuraci√≥n GPS</h2>
                    </div>

                    {/* CONFIGURACI√ìN GLOBAL GPS */}
                    <div style={{
                        background: gpsConfig.enabled ? '#f0fdf4' : '#fef2f2',
                        padding: '20px',
                        borderRadius: '8px',
                        marginBottom: '20px',
                        border: gpsConfig.enabled ? '2px solid #10b981' : '2px solid #ef4444'
                    }}>
                        <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'space-between',
                            marginBottom: '20px',
                            paddingBottom: '15px',
                            borderBottom: '1px solid rgba(0,0,0,0.1)'
                        }}>
                            <h3 style={{margin: 0, fontSize: '18px', fontWeight: '600'}}>
                                Estado GPS del Sistema
                            </h3>
                            <div style={{
                                fontSize: '24px',
                                fontWeight: '700',
                                color: gpsConfig.enabled ? '#10b981' : '#ef4444'
                            }}>
                                {gpsConfig.enabled ? 'üü¢ ACTIVO' : 'üî¥ DESACTIVADO'}
                            </div>
                        </div>

                        <div style={{display: 'grid', gap: '15px'}}>
                            <label style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '12px',
                                padding: '15px',
                                background: 'white',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                border: '2px solid ' + (gpsConfig.enabled ? '#10b981' : '#e5e7eb')
                            }}>
                                <input
                                    type="checkbox"
                                    checked={gpsConfig.enabled}
                                    onChange={(e) => {
                                        const newConfig = {...gpsConfig, enabled: e.target.checked};
                                        saveGPSConfig(newConfig);
                                        showNotification(
                                            e.target.checked 
                                                ? '‚úÖ GPS ACTIVADO - Validar√° ubicaci√≥n en fichajes' 
                                                : '‚ö†Ô∏è GPS DESACTIVADO - No validar√° ubicaci√≥n (solo para pruebas)',
                                            e.target.checked ? 'success' : 'warning'
                                        );
                                    }}
                                    style={{width: '20px', height: '20px', cursor: 'pointer'}}
                                />
                                <div>
                                    <div style={{fontWeight: '600', fontSize: '15px', marginBottom: '4px'}}>
                                        Activar validaci√≥n GPS
                                    </div>
                                    <div style={{fontSize: '13px', color: '#6b7280'}}>
                                        {gpsConfig.enabled 
                                            ? 'Los trabajadores deben estar en la obra para fichar'
                                            : '‚ö†Ô∏è DESACTIVADO: Permite fichar desde cualquier lugar (solo pruebas/desarrollo)'
                                        }
                                    </div>
                                </div>
                            </label>

                            {!gpsConfig.enabled && (
                                <div style={{
                                    background: '#fef3c7',
                                    border: '1px solid #fbbf24',
                                    padding: '12px 15px',
                                    borderRadius: '6px',
                                    fontSize: '13px',
                                    color: '#92400e'
                                }}>
                                    <strong>‚ö†Ô∏è ATENCI√ìN:</strong> GPS desactivado. √ötil para pruebas desde PC. 
                                    Recuerda activarlo antes de usar en producci√≥n con celulares.
                                </div>
                            )}

                            <div style={{
                                opacity: gpsConfig.enabled ? 1 : 0.5,
                                pointerEvents: gpsConfig.enabled ? 'auto' : 'none'
                            }}>
                                <label style={{fontWeight: '600', display: 'block', marginBottom: '12px', fontSize: '14px'}}>
                                    Modo de validaci√≥n:
                                </label>
                                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '12px'}}>
                                    <label style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '10px',
                                        padding: '14px',
                                        border: gpsConfig.mode === 'alert' ? '2px solid #f59e0b' : '2px solid #d1d5db',
                                        borderRadius: '8px',
                                        cursor: 'pointer',
                                        background: gpsConfig.mode === 'alert' ? '#fffbeb' : 'white',
                                        transition: 'all 0.2s'
                                    }}>
                                        <input
                                            type="radio"
                                            checked={gpsConfig.mode === 'alert'}
                                            onChange={() => {
                                                const newConfig = {...gpsConfig, mode: 'alert'};
                                                saveGPSConfig(newConfig);
                                                showNotification('Modo Alerta activado: Permite fichar con advertencia', 'info');
                                            }}
                                            style={{width: '18px', height: '18px', cursor: 'pointer'}}
                                        />
                                        <div style={{flex: 1}}>
                                            <div style={{fontWeight: '600', fontSize: '14px', color: '#92400e', marginBottom: '2px'}}>
                                                ALERTA
                                            </div>
                                            <div style={{fontSize: '12px', color: '#78716c'}}>
                                                Permite fichar con advertencia
                                            </div>
                                        </div>
                                    </label>
                                    <label style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '10px',
                                        padding: '14px',
                                        border: gpsConfig.mode === 'block' ? '2px solid #dc2626' : '2px solid #d1d5db',
                                        borderRadius: '8px',
                                        cursor: 'pointer',
                                        background: gpsConfig.mode === 'block' ? '#fef2f2' : 'white',
                                        transition: 'all 0.2s'
                                    }}>
                                        <input
                                            type="radio"
                                            checked={gpsConfig.mode === 'block'}
                                            onChange={() => {
                                                const newConfig = {...gpsConfig, mode: 'block'};
                                                saveGPSConfig(newConfig);
                                                showNotification('Modo Bloqueo activado: Impide fichar fuera de rango', 'info');
                                            }}
                                            style={{width: '18px', height: '18px', cursor: 'pointer'}}
                                        />
                                        <div style={{flex: 1}}>
                                            <div style={{fontWeight: '600', fontSize: '14px', color: '#991b1b', marginBottom: '2px'}}>
                                                BLOQUEO
                                            </div>
                                            <div style={{fontSize: '12px', color: '#78716c'}}>
                                                Impide fichar fuera de rango
                                            </div>
                                        </div>
                                    </label>
                                </div>
                                <div style={{
                                    fontSize: '13px', 
                                    color: '#4b5563', 
                                    padding: '12px',
                                    background: '#f9fafb',
                                    borderRadius: '6px',
                                    borderLeft: `3px solid ${gpsConfig.mode === 'alert' ? '#f59e0b' : '#dc2626'}`
                                }}>
                                    <strong>Informaci√≥n:</strong> {gpsConfig.mode === 'alert' 
                                        ? 'Los trabajadores podr√°n fichar pero ver√°n una advertencia si est√°n fuera del rango permitido.'
                                        : 'Los trabajadores NO podr√°n completar el fichaje si est√°n fuera del rango permitido.'
                                    }
                                </div>
                            </div>

                            <div>
                                <label style={{fontWeight: '500', display: 'block', marginBottom: '8px'}}>
                                    Radio por defecto: {gpsConfig.defaultRadius}m
                                </label>
                                <input
                                    type="range"
                                    min="10"
                                    max="500"
                                    step="10"
                                    value={gpsConfig.defaultRadius}
                                    onChange={(e) => {
                                        const newConfig = {...gpsConfig, defaultRadius: parseInt(e.target.value)};
                                        saveGPSConfig(newConfig);
                                    }}
                                    style={{width: '100%'}}
                                />
                                <div style={{fontSize: '13px', color: '#6b7280', marginTop: '5px'}}>
                                    M√≠nimo: 10m ‚Ä¢ M√°ximo: 500m ‚Ä¢ Recomendado: 50-150m
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* OBRAS */}
                    <div style={{marginTop: '30px'}}>
                        <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            marginBottom: '20px'
                        }}>
                            <h3 style={{fontSize: '18px', fontWeight: '600', color: '#1f2937'}}>
                                Obras Registradas
                            </h3>
                            <button
                                onClick={handleNewObra}
                                className="btn btn-success"
                                style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                    padding: '10px 20px'
                                }}
                            >
                                <span style={{fontSize: '18px'}}>+</span>
                                Nueva Obra
                            </button>
                        </div>

                        {/* BUSCADOR */}
                        <div style={{marginBottom: '20px'}}>
                            <input
                                type="text"
                                placeholder="Buscar obra por nombre, cliente o ID..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                style={{
                                    width: '100%',
                                    padding: '12px',
                                    border: '1px solid #d1d5db',
                                    borderRadius: '8px',
                                    fontSize: '14px'
                                }}
                            />
                            <div style={{marginTop: '8px', fontSize: '13px', color: '#6b7280'}}>
                                {filteredObras.length} de {obras.length} obras | {obras.filter(o => o.lat && o.lng).length} con GPS configurado
                            </div>
                        </div>
                    </div>

                    {/* LISTA DE OBRAS */}
                    <div style={{display: 'grid', gap: '15px'}}>
                        {filteredObras.map(obra => (
                            <div key={obra.id} style={{
                                background: 'white',
                                border: '1px solid #e5e7eb',
                                borderRadius: '8px',
                                padding: '15px'
                            }}>
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '10px'}}>
                                    <div style={{flex: 1}}>
                                        <div style={{fontWeight: '600', fontSize: '16px', marginBottom: '4px', color: '#1f2937'}}>
                                            {obra.nombre_obra}
                                        </div>
                                        <div style={{fontSize: '13px', color: '#6b7280'}}>
                                            {obra.cliente} ‚Ä¢ ID: {obra.id}
                                        </div>
                                    </div>
                                    <div style={{display: 'flex', gap: '8px', marginLeft: '10px'}}>
                                        <button
                                            onClick={() => handleEditObra(obra)}
                                            className="btn btn-primary"
                                            style={{padding: '8px 16px', fontSize: '13px', whiteSpace: 'nowrap'}}
                                        >
                                            {obra.lat && obra.lng ? 'Editar' : 'Configurar GPS'}
                                        </button>
                                        <button
                                            onClick={() => handleDeleteObra(obra)}
                                            className="btn btn-danger"
                                            style={{
                                                padding: '8px 16px', 
                                                fontSize: '13px', 
                                                whiteSpace: 'nowrap',
                                                background: '#dc2626',
                                                color: 'white'
                                            }}
                                            title="Eliminar obra"
                                        >
                                            Eliminar
                                        </button>
                                    </div>
                                </div>

                                {obra.lat && obra.lng ? (
                                    <div style={{
                                        background: '#ecfdf5',
                                        padding: '12px',
                                        borderRadius: '6px',
                                        fontSize: '13px',
                                        border: '1px solid #a7f3d0'
                                    }}>
                                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '12px', marginBottom: '8px'}}>
                                            <div>
                                                <div style={{color: '#6b7280', fontSize: '11px', marginBottom: '2px'}}>Latitud</div>
                                                <div style={{fontWeight: '600', fontFamily: 'monospace', fontSize: '12px'}}>{obra.lat.toFixed(6)}</div>
                                            </div>
                                            <div>
                                                <div style={{color: '#6b7280', fontSize: '11px', marginBottom: '2px'}}>Longitud</div>
                                                <div style={{fontWeight: '600', fontFamily: 'monospace', fontSize: '12px'}}>{obra.lng.toFixed(6)}</div>
                                            </div>
                                            <div>
                                                <div style={{color: '#6b7280', fontSize: '11px', marginBottom: '2px'}}>Radio</div>
                                                <div style={{fontWeight: '600', fontSize: '12px'}}>{obra.radius} metros</div>
                                            </div>
                                        </div>
                                        <div style={{color: '#059669', fontWeight: '500', fontSize: '12px'}}>
                                            GPS configurado correctamente
                                        </div>
                                    </div>
                                ) : (
                                    <div style={{
                                        background: '#fef3c7',
                                        padding: '12px',
                                        borderRadius: '6px',
                                        fontSize: '13px',
                                        color: '#92400e',
                                        border: '1px solid #fcd34d'
                                    }}>
                                        Sin coordenadas GPS configuradas
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>

                    {/* MODAL EDITAR OBRA */}
                    {showModal && editingObra && (
                        <div style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            background: 'rgba(0,0,0,0.5)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            zIndex: 1000,
                            padding: '20px'
                        }} onClick={() => setShowModal(false)}>
                            <div style={{
                                background: 'white',
                                borderRadius: '12px',
                                padding: '30px',
                                maxWidth: '600px',
                                width: '100%',
                                maxHeight: '90vh',
                                overflow: 'auto'
                            }} onClick={(e) => e.stopPropagation()}>
                                <h3 style={{marginBottom: '20px', fontSize: '20px', fontWeight: '600', color: '#1f2937'}}>
                                    {editingObra.isNew ? "Nueva Obra" : `Configurar GPS: ${editingObra.nombre_obra}`}
                                </h3>

                                {/* DATOS DE LA OBRA - Solo editable en obras nuevas */}
                                {editingObra.isNew && (
                                    <div style={{marginBottom: '25px', padding: '20px', background: '#f9fafb', borderRadius: '8px', border: '1px solid #e5e7eb'}}>
                                        <h4 style={{marginBottom: '15px', fontSize: '16px', fontWeight: '600', color: '#374151'}}>
                                            Datos de la Obra
                                        </h4>
                                        
                                        <div style={{display: 'grid', gap: '15px'}}>
                                            <div>
                                                <label style={{display: 'block', marginBottom: '8px', fontWeight: '500', color: '#374151'}}>
                                                    Nombre de la Obra: <span style={{color: '#ef4444'}}>*</span>
                                                </label>
                                                <input type="text" placeholder="Ej: OBRA PRINCIPAL VIGO" value={editingObra.nombre_obra} onChange={(e) => setEditingObra({...editingObra, nombre_obra: e.target.value})} style={{width: '100%', padding: '10px', border: '1px solid #d1d5db', borderRadius: '6px', fontSize: '14px'}} />
                                            </div>

                                            <div>
                                                <label style={{display: 'block', marginBottom: '8px', fontWeight: '500', color: '#374151'}}>
                                                    Cliente: <span style={{color: '#ef4444'}}>*</span>
                                                </label>
                                                <input type="text" placeholder="Ej: Torres Idilicas S.L." value={editingObra.cliente} onChange={(e) => setEditingObra({...editingObra, cliente: e.target.value})} style={{width: '100%', padding: '10px', border: '1px solid #d1d5db', borderRadius: '6px', fontSize: '14px'}} />
                                            </div>

                                            <div>
                                                <label style={{display: 'block', marginBottom: '8px', fontWeight: '500', color: '#374151'}}>
                                                    ID de la Obra:
                                                </label>
                                                <input type="text" value={editingObra.id} disabled style={{width: '100%', padding: '10px', border: '1px solid #d1d5db', borderRadius: '6px', fontSize: '14px', background: '#f3f4f6', color: '#6b7280'}} />
                                                <div style={{fontSize: '12px', color: '#6b7280', marginTop: '5px'}}>
                                                    El ID se genera autom√°ticamente
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* BUSCAR POR DIRECCI√ìN */}
                                <div style={{marginBottom: '20px'}}>
                                    <label style={{display: 'block', marginBottom: '8px', fontWeight: '500', color: '#374151'}}>
                                        Buscar por direcci√≥n:
                                    </label>
                                    <div style={{display: 'flex', gap: '10px'}}>
                                        <input
                                            type="text"
                                            placeholder='Ejemplo: "Calle Pr√≠ncipe 59, Vigo" o "EDAR Ourense"'
                                            value={searchAddress}
                                            onChange={(e) => setSearchAddress(e.target.value)}
                                            onKeyPress={(e) => e.key === 'Enter' && handleSearchAddress()}
                                            style={{
                                                flex: 1,
                                                padding: '10px',
                                                border: '1px solid #d1d5db',
                                                borderRadius: '6px',
                                                fontSize: '14px'
                                            }}
                                            disabled={isGeocoding}
                                        />
                                        <button
                                            onClick={handleSearchAddress}
                                            disabled={isGeocoding}
                                            className="btn btn-primary"
                                            style={{minWidth: '100px'}}
                                        >
                                            {isGeocoding ? 'Buscando...' : 'Buscar'}
                                        </button>
                                    </div>
                                    <div style={{fontSize: '12px', color: '#6b7280', marginTop: '5px'}}>
                                        Introduce direcci√≥n completa o nombre del lugar + ciudad
                                    </div>
                                </div>

                                <div style={{
                                    textAlign: 'center',
                                    margin: '15px 0',
                                    color: '#9ca3af',
                                    fontWeight: '500'
                                }}>
                                    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  O  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                                </div>

                                {/* USAR UBICACI√ìN ACTUAL */}
                                <div style={{marginBottom: '20px'}}>
                                    <button
                                        onClick={handleGetCurrentLocation}
                                        className="btn btn-secondary"
                                        style={{width: '100%', padding: '12px'}}
                                    >
                                        Usar Mi Ubicaci√≥n Actual
                                    </button>
                                    <div style={{fontSize: '12px', color: '#6b7280', marginTop: '5px', textAlign: 'center'}}>
                                        Ve f√≠sicamente a la obra y usa esta opci√≥n
                                    </div>
                                </div>

                                {/* COORDENADAS ACTUALES */}
                                {editingObra.lat && editingObra.lng && (
                                    <div style={{
                                        background: '#ecfdf5',
                                        padding: '15px',
                                        borderRadius: '8px',
                                        marginBottom: '20px',
                                        border: '1px solid #a7f3d0'
                                    }}>
                                        <div style={{fontWeight: '600', marginBottom: '10px', color: '#059669'}}>
                                            Coordenadas configuradas
                                        </div>
                                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', fontSize: '14px'}}>
                                            <div>
                                                <div style={{color: '#6b7280', fontSize: '12px'}}>Latitud:</div>
                                                <div style={{fontFamily: 'monospace', fontWeight: '500'}}>
                                                    {editingObra.lat.toFixed(6)}
                                                </div>
                                            </div>
                                            <div>
                                                <div style={{color: '#6b7280', fontSize: '12px'}}>Longitud:</div>
                                                <div style={{fontFamily: 'monospace', fontWeight: '500'}}>
                                                    {editingObra.lng.toFixed(6)}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* RADIO */}
                                <div style={{marginBottom: '20px'}}>
                                    <label style={{display: 'block', marginBottom: '8px', fontWeight: '500', color: '#374151'}}>
                                        Radio de validaci√≥n: {editingObra.radius}m
                                    </label>
                                    <input
                                        type="range"
                                        min="10"
                                        max="500"
                                        step="10"
                                        value={editingObra.radius}
                                        onChange={(e) => setEditingObra({...editingObra, radius: parseInt(e.target.value)})}
                                        style={{width: '100%'}}
                                    />
                                    <div style={{fontSize: '12px', color: '#6b7280', marginTop: '5px'}}>
                                        Rango: 10m a 500m ‚Ä¢ Los trabajadores deben estar dentro de este radio para fichar
                                    </div>
                                </div>

                                {/* BOTONES */}
                                <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
                                    <button
                                        onClick={() => {
                                            setShowModal(false);
                                            setEditingObra(null);
                                        }}
                                        className="btn btn-secondary"
                                        style={{flex: 1}}
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        onClick={handleSaveObra}
                                        className="btn btn-primary"
                                        style={{flex: 1}}
                                        disabled={!editingObra.lat || !editingObra.lng}
                                    >
                                        Guardar Configuraci√≥n
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const UserManagement = ({ showNotification }) => {
            const [users, setUsers] = useState([]);
            const [showModal, setShowModal] = useState(false);
            const [editingUser, setEditingUser] = useState(null);
            const [formData, setFormData] = useState({
                id: '',
                nombre: '',
                usuario: '',
                password: ''
            });
            const [searchTerm, setSearchTerm] = useState('');

            // Cargar usuarios al montar
            useEffect(() => {
                loadUsers();
            }, []);

            const loadUsers = () => {
                const savedUsers = localStorage.getItem('app_users');
                if (savedUsers) {
                    setUsers(JSON.parse(savedUsers));
                } else {
                    // Si no hay usuarios guardados, usar los de COMPANY_DATA
                    const initialUsers = COMPANY_DATA.trabajadores.map(t => ({...t}));
                    localStorage.setItem('app_users', JSON.stringify(initialUsers));
                    setUsers(initialUsers);
                }
            };

            const saveUsers = (updatedUsers) => {
                localStorage.setItem('app_users', JSON.stringify(updatedUsers));
                setUsers(updatedUsers);
                // Actualizar tambi√©n COMPANY_DATA para que el resto de la app lo vea
                COMPANY_DATA.trabajadores = updatedUsers;
            };

            const openAddModal = () => {
                setEditingUser(null);
                setFormData({
                    id: '', // ID vac√≠o para que lo ingrese el usuario
                    nombre: '',
                    usuario: '',
                    password: '1234', // Contrase√±a por defecto
                    role: 'worker' // Rol por defecto
                });
                setShowModal(true);
            };

            const openEditModal = (user) => {
                setEditingUser(user);
                setFormData({...user});
                setShowModal(true);
            };

            const closeModal = () => {
                setShowModal(false);
                setEditingUser(null);
                setFormData({id: '', nombre: '', usuario: '', password: ''});
            };

            const handleSubmit = (e) => {
                e.preventDefault();

                // Limpiar datos antes de validar
                const cleanedData = {
                    id: String(formData.id).trim(),
                    nombre: formData.nombre.trim().toUpperCase(),
                    usuario: formData.usuario.trim().toLowerCase(),
                    password: formData.password.trim(),
                    role: formData.role || 'worker',
                    has_face_registered: formData.has_face_registered || false
                };

                // Validaciones
                if (!cleanedData.id) {
                    alert('El ID del trabajador es obligatorio\n\nEste ID debe coincidir con el sistema de RR.HH.');
                    return;
                }
                if (!cleanedData.nombre) {
                    alert('El nombre es obligatorio');
                    return;
                }
                if (!cleanedData.usuario) {
                    alert('El usuario es obligatorio');
                    return;
                }
                if (!cleanedData.password) {
                    alert('La contrase√±a es obligatoria');
                    return;
                }

                // Verificar ID duplicado (solo al crear nuevo usuario)
                if (!editingUser) {
                    const duplicateId = users.find(u => String(u.id).trim() === cleanedData.id);
                    if (duplicateId) {
                        alert(`Ya existe un trabajador con ID: ${cleanedData.id}\n\nTrabajador: ${duplicateId.nombre}\n\nUsa un ID diferente.`);
                        return;
                    }
                }

                // Verificar usuario duplicado (excepto si estamos editando el mismo)
                const duplicateUser = users.find(u => 
                    String(u.usuario).toLowerCase().trim() === cleanedData.usuario 
                    && String(u.id).trim() !== cleanedData.id
                );
                if (duplicateUser) {
                    alert('Ya existe un usuario con ese nombre de usuario');
                    return;
                }

                let updatedUsers;
                if (editingUser) {
                    // Editar usuario existente
                    updatedUsers = users.map(u => 
                        String(u.id).trim() === cleanedData.id ? cleanedData : u
                    );
                    showNotification(`Usuario ${cleanedData.nombre} actualizado correctamente`, 'success');
                } else {
                    // A√±adir nuevo usuario con datos limpios
                    updatedUsers = [...users, cleanedData];
                    showNotification(
                        `‚úÖ Usuario creado correctamente\n\n` +
                        `ID: ${cleanedData.id}\n` +
                        `Nombre: ${cleanedData.nombre}\n` +
                        `Usuario: ${cleanedData.usuario}\n` +
                        `Password: ${cleanedData.password}\n\n` +
                        `El trabajador ya puede iniciar sesi√≥n`,
                        'success'
                    );
                }

                saveUsers(updatedUsers);
                closeModal();
            };

            const deleteUser = (userId) => {
                const user = users.find(u => u.id === userId);
                if (!confirm(`¬øEst√°s seguro de eliminar a ${user.nombre}?\n\nEsto tambi√©n eliminar√° su registro facial si existe.`)) {
                    return;
                }

                const updatedUsers = users.filter(u => u.id !== userId);
                saveUsers(updatedUsers);

                // Eliminar tambi√©n su registro facial si existe
                const faceRegs = JSON.parse(localStorage.getItem('face_registrations') || '{}');
                if (faceRegs[userId]) {
                    delete faceRegs[userId];
                    localStorage.setItem('face_registrations', JSON.stringify(faceRegs));
                }

                showNotification(`Usuario ${user.nombre} eliminado`, 'success');
            };

            const resetPassword = (userId) => {
                const user = users.find(u => u.id === userId);
                if (!confirm(`¬øRestablecer contrase√±a de ${user.nombre} a "1234"?`)) {
                    return;
                }

                const updatedUsers = users.map(u =>
                    u.id === userId ? {...u, password: '1234'} : u
                );
                saveUsers(updatedUsers);
                showNotification(`Contrase√±a de ${user.nombre} restablecida a "1234"`, 'success');
            };

            // NUEVO: Exportar usuarios para sincronizar
            const exportUsers = () => {
                const dataStr = JSON.stringify(users, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `usuarios_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                showNotification('Usuarios exportados. Usa este archivo en otro dispositivo.', 'success');
            };

            // NUEVO: Importar usuarios desde otro dispositivo
            const importUsers = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedUsers = JSON.parse(e.target.result);
                        
                        if (!Array.isArray(importedUsers)) {
                            throw new Error('Formato inv√°lido');
                        }

                        // Preguntar si quiere reemplazar o fusionar
                        const action = confirm(
                            '¬øC√≥mo quieres importar?\n\n' +
                            'OK = REEMPLAZAR todos los usuarios\n' +
                            'Cancelar = FUSIONAR (mantener existentes + a√±adir nuevos)'
                        );

                        let finalUsers;
                        if (action) {
                            // Reemplazar todo
                            finalUsers = importedUsers;
                        } else {
                            // Fusionar: mantener existentes y a√±adir nuevos
                            const existingIds = users.map(u => u.id);
                            const newUsers = importedUsers.filter(u => !existingIds.includes(u.id));
                            finalUsers = [...users, ...newUsers];
                        }

                        saveUsers(finalUsers);
                        showNotification(
                            `Usuarios importados correctamente. Total: ${finalUsers.length}`,
                            'success'
                        );
                    } catch (error) {
                        showNotification('Error al importar usuarios. Verifica el archivo.', 'error');
                    }
                };
                reader.readAsText(file);
            };

            // Filtrar usuarios
            const filteredUsers = users.filter(u =>
                u.nombre.toLowerCase().includes(searchTerm.toLowerCase()) ||
                u.usuario.toLowerCase().includes(searchTerm.toLowerCase()) ||
                u.id.toString().includes(searchTerm)
            );

            return (
                <div className="card">
                    <div className="card-header">
                        <h2 className="card-title">Gesti√≥n de Usuarios</h2>
                        <button className="btn btn-primary" onClick={openAddModal}>
                            + A√±adir Usuario
                        </button>
                    </div>

                    {/* Estad√≠sticas */}
                    <div style={{padding: '20px', background: '#f8f9fa', borderBottom: '1px solid #e5e7eb'}}>
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '20px'}}>
                            <div style={{textAlign: 'center'}}>
                                <div style={{fontSize: '32px', fontWeight: 'bold', color: '#2563eb'}}>{users.length}</div>
                                <div style={{fontSize: '14px', color: '#6b7280'}}>Total Usuarios</div>
                            </div>
                        </div>
                    </div>

                    {/* B√∫squeda y Sincronizaci√≥n */}
                    <div style={{padding: '20px', borderBottom: '1px solid #e5e7eb'}}>
                        <input
                            type="text"
                            placeholder="Buscar por nombre, usuario o ID..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '12px 20px',
                                border: '2px solid #e5e7eb',
                                borderRadius: '8px',
                                fontSize: '15px',
                                marginBottom: '15px'
                            }}
                        />
                        
                        {/* Botones de Sincronizaci√≥n */}
                        <div style={{
                            display: 'flex',
                            gap: '10px',
                            padding: '15px',
                            background: '#fef3c7',
                            border: '1px solid #fbbf24',
                            borderRadius: '8px',
                            alignItems: 'center'
                        }}>
                            <div style={{flex: 1, fontSize: '13px', color: '#92400e'}}>
                                <strong>Sincronizaci√≥n entre dispositivos:</strong> Exporta usuarios de este dispositivo e imp√≥rtalos en otro.
                            </div>
                            <button 
                                onClick={exportUsers}
                                className="btn btn-warning"
                                style={{whiteSpace: 'nowrap', padding: '8px 16px'}}
                            >
                                Exportar Usuarios
                            </button>
                            <label style={{
                                cursor: 'pointer',
                                padding: '8px 16px',
                                background: '#10b981',
                                color: 'white',
                                borderRadius: '6px',
                                fontSize: '14px',
                                fontWeight: '600',
                                whiteSpace: 'nowrap'
                            }}>
                                Importar Usuarios
                                <input 
                                    type="file" 
                                    accept=".json"
                                    onChange={importUsers}
                                    style={{display: 'none'}}
                                />
                            </label>
                        </div>
                    </div>

                    {/* Tabla de usuarios */}
                    <div className="table-container">
                        <table className="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Usuario</th>
                                    <th>Contrase√±a</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredUsers.map(user => (
                                    <tr key={user.id}>
                                        <td>{user.id}</td>
                                        <td style={{fontWeight: '600'}}>{user.nombre}</td>
                                        <td>{user.usuario}</td>
                                        <td>
                                            <span style={{
                                                background: '#e0e7ff',
                                                padding: '4px 8px',
                                                borderRadius: '4px',
                                                fontFamily: 'monospace',
                                                fontSize: '12px'
                                            }}>
                                                {'‚Ä¢'.repeat(user.password.length)}
                                            </span>
                                        </td>
                                        <td>
                                            <div style={{display: 'flex', gap: '5px'}}>
                                                <button
                                                    className="btn btn-secondary"
                                                    onClick={() => openEditModal(user)}
                                                    style={{fontSize: '12px', padding: '6px 12px'}}
                                                >
                                                    ‚úèÔ∏è Editar
                                                </button>
                                                <button
                                                    className="btn btn-warning"
                                                    onClick={() => resetPassword(user.id)}
                                                    style={{fontSize: '12px', padding: '6px 12px'}}
                                                >
                                                    üîë Reset
                                                </button>
                                                <button
                                                    className="btn btn-danger"
                                                    onClick={() => deleteUser(user.id)}
                                                    style={{fontSize: '12px', padding: '6px 12px'}}
                                                >
                                                    ‚ùå Eliminar
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {/* Modal de a√±adir/editar */}
                    {showModal && (
                        <div style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            background: 'rgba(0,0,0,0.7)',
                            display: 'flex',
                            justifyContent: 'center',
                            alignItems: 'center',
                            zIndex: 1000
                        }}>
                            <div style={{
                                background: 'white',
                                borderRadius: '15px',
                                padding: '30px',
                                maxWidth: '500px',
                                width: '90%'
                            }}>
                                <h3 style={{marginBottom: '20px', color: '#2563eb'}}>
                                    {editingUser ? 'Editar Usuario' : 'Nuevo Usuario'}
                                </h3>

                                <form onSubmit={handleSubmit}>
                                    {!editingUser && (
                                        <div className="form-group">
                                            <label className="form-label">
                                                ID del Trabajador * 
                                                <span style={{fontSize: '12px', fontWeight: 'normal', color: '#6b7280', marginLeft: '8px'}}>
                                                    (del sistema de RR.HH.)
                                                </span>
                                            </label>
                                            <input
                                                type="text"
                                                className="form-input"
                                                value={formData.id}
                                                onChange={(e) => setFormData({...formData, id: e.target.value})}
                                                placeholder="Ej: 1001, EMP-2024-001, etc"
                                                style={{
                                                    background: 'white',
                                                    border: '2px solid #3b82f6',
                                                    fontSize: '16px',
                                                    fontWeight: '600'
                                                }}
                                                autoFocus
                                            />
                                            <small style={{
                                                color: '#dc2626', 
                                                fontSize: '12px',
                                                display: 'block',
                                                marginTop: '5px',
                                                fontWeight: '500'
                                            }}>
                                                ‚ö†Ô∏è Debe coincidir con el ID de Recursos Humanos
                                            </small>
                                        </div>
                                    )}

                                    {editingUser && (
                                        <div className="form-group">
                                            <label className="form-label">ID del Trabajador</label>
                                            <input
                                                type="text"
                                                className="form-input"
                                                value={formData.id}
                                                disabled
                                                style={{
                                                    background: '#f3f4f6',
                                                    color: '#6b7280',
                                                    fontWeight: '600'
                                                }}
                                            />
                                            <small style={{color: '#6b7280', fontSize: '12px'}}>
                                                El ID no se puede cambiar
                                            </small>
                                        </div>
                                    )}

                                    <div className="form-group">
                                        <label className="form-label">Nombre Completo *</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            value={formData.nombre}
                                            onChange={(e) => setFormData({...formData, nombre: e.target.value})}
                                            placeholder="Ej: JUAN P√âREZ GARC√çA"
                                            style={{textTransform: 'uppercase'}}
                                        />
                                    </div>

                                    <div className="form-group">
                                        <label className="form-label">Usuario (Login) *</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            value={formData.usuario}
                                            onChange={(e) => setFormData({...formData, usuario: e.target.value.toLowerCase()})}
                                            placeholder="Ej: juan.perez"
                                        />
                                    </div>

                                    <div className="form-group">
                                        <label className="form-label">Contrase√±a *</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            value={formData.password}
                                            onChange={(e) => setFormData({...formData, password: e.target.value})}
                                            placeholder="Contrase√±a"
                                        />
                                        <small style={{color: '#6b7280', fontSize: '12px'}}>
                                            Por defecto: "1234"
                                        </small>
                                    </div>

                                    <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
                                        <button type="submit" className="btn btn-primary" style={{flex: 1}}>
                                            {editingUser ? 'Guardar Cambios' : 'Crear Usuario'}
                                        </button>
                                        <button
                                            type="button"
                                            className="btn btn-secondary"
                                            onClick={closeModal}
                                            style={{flex: 1}}
                                        >
                                            Cancelar
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Componente de Registro Facial
        const FaceRegistration = ({ currentUser, showNotification }) => {
            const [registeredFaces, setRegisteredFaces] = useState({});
            const [selectedWorker, setSelectedWorker] = useState(null);
            const [captureMode, setCaptureMode] = useState(null); // 'camera' o 'file'
            const [processing, setProcessing] = useState(false);
            const [modelsLoaded, setModelsLoaded] = useState(false);
            const [stream, setStream] = useState(null);
            const [capturedImage, setCapturedImage] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [workers, setWorkers] = useState([]);
            
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const fileInputRef = useRef(null);

            // Cargar registros existentes y modelos de Face-API
            useEffect(() => {
                const loadData = async () => {
                    // Cargar trabajadores din√°micos
                    const savedUsers = localStorage.getItem('app_users');
                    if (savedUsers) {
                        setWorkers(JSON.parse(savedUsers));
                    } else {
                        setWorkers(COMPANY_DATA.trabajadores);
                    }
                    
                    // Cargar registros guardados
                    const saved = localStorage.getItem('face_registrations') || '{}';
                    setRegisteredFaces(JSON.parse(saved));
                    
                    // Cargar modelos Face-API
                    const loaded = await loadFaceApiModels();
                    setModelsLoaded(loaded);
                    
                    if (!loaded) {
                        showNotification('Error cargando sistema de reconocimiento facial', 'error');
                    }
                };
                
                loadData();
            }, []);

            // Limpiar stream al desmontar
            useEffect(() => {
                return () => {
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                };
            }, [stream]);

            // Filtrar trabajadores
            const filteredWorkers = workers.filter(w => 
                w.nombre.toLowerCase().includes(searchTerm.toLowerCase()) ||
                w.id.toString().includes(searchTerm)
            );

            // Estad√≠sticas
            const totalWorkers = workers.length;
            const registeredCount = Object.keys(registeredFaces).length;
            const pendingCount = totalWorkers - registeredCount;

            // Iniciar c√°mara
            const startCamera = async (worker) => {
                try {
                    setSelectedWorker(worker);
                    setCaptureMode('camera');
                    setProcessing(true);
                    
                    const mediaStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: 'user'
                        }
                    });
                    
                    setStream(mediaStream);
                    
                    if (videoRef.current) {
                        videoRef.current.srcObject = mediaStream;
                        await videoRef.current.play();
                    }
                    
                    setProcessing(false);
                } catch (error) {
                    console.error('Error accediendo a la c√°mara:', error);
                    showNotification('No se pudo acceder a la c√°mara', 'error');
                    setProcessing(false);
                    setCaptureMode(null);
                }
            };

            // Capturar foto desde c√°mara
            const capturePhoto = async () => {
                if (!videoRef.current || !canvasRef.current) return;
                
                setProcessing(true);
                
                try {
                    const video = videoRef.current;
                    const canvas = canvasRef.current;
                    
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0);
                    
                    const imageData = canvas.toDataURL('image/jpeg', 0.9);
                    setCapturedImage(imageData);
                    
                    // Detener stream
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                        setStream(null);
                    }
                    
                    // Extraer descriptor
                    await extractAndSaveDescriptor(canvas, imageData);
                    
                } catch (error) {
                    console.error('Error capturando foto:', error);
                    showNotification('Error al capturar la foto', 'error');
                    setProcessing(false);
                }
            };

            // Subir foto desde archivo
            const handleFileUpload = async (e, worker) => {
                const file = e.target.files[0];
                if (!file) return;
                
                setSelectedWorker(worker);
                setCaptureMode('file');
                setProcessing(true);
                
                try {
                    const reader = new FileReader();
                    
                    reader.onload = async (event) => {
                        const imageData = event.target.result;
                        setCapturedImage(imageData);
                        
                        // Crear imagen para face-api
                        const img = new Image();
                        img.onload = async () => {
                            try {
                                await extractAndSaveDescriptor(img, imageData);
                            } catch (error) {
                                console.error('Error procesando imagen:', error);
                                showNotification('Error procesando la imagen', 'error');
                                setProcessing(false);
                            }
                        };
                        img.src = imageData;
                    };
                    
                    reader.readAsDataURL(file);
                } catch (error) {
                    console.error('Error cargando archivo:', error);
                    showNotification('Error cargando el archivo', 'error');
                    setProcessing(false);
                }
            };

            // Extraer descriptor facial y guardar
            const extractAndSaveDescriptor = async (imageSource, imageData) => {
                try {
                    // Intentar detectar todos los rostros primero
                    const detections = await faceapi
                        .detectAllFaces(imageSource, new faceapi.TinyFaceDetectorOptions())
                        .withFaceLandmarks()
                        .withFaceDescriptors();
                    
                    // Diagn√≥stico detallado si falla
                    if (!detections || detections.length === 0) {
                        showNotification(
                            '‚ùå NO SE DETECT√ì NING√öN ROSTRO\n\n' +
                            'Posibles causas:\n' +
                            '‚Ä¢ Foto muy oscura o borrosa\n' +
                            '‚Ä¢ Rostro muy peque√±o en la imagen\n' +
                            '‚Ä¢ Rostro de perfil o girado\n' +
                            '‚Ä¢ Accesorios que cubren la cara\n\n' +
                            'Recomendaci√≥n:\n' +
                            '‚Ä¢ Buena iluminaci√≥n frontal\n' +
                            '‚Ä¢ Rostro mirando de frente\n' +
                            '‚Ä¢ Sin lentes oscuros ni mascarilla\n' +
                            '‚Ä¢ Ac√©rcate m√°s a la c√°mara',
                            'error'
                        );
                        setProcessing(false);
                        setCapturedImage(null);
                        return;
                    }
                    
                    if (detections.length > 1) {
                        showNotification(
                            `‚ùå SE DETECTARON ${detections.length} ROSTROS\n\n` +
                            'El sistema solo acepta fotos con UNA persona.\n\n' +
                            'Por favor:\n' +
                            '‚Ä¢ Toma la foto individualmente\n' +
                            '‚Ä¢ Sin otras personas en el fondo\n' +
                            '‚Ä¢ Enfoca solo el rostro del trabajador',
                            'error'
                        );
                        setProcessing(false);
                        setCapturedImage(null);
                        return;
                    }
                    
                    const detection = detections[0];
                    
                    // Verificar calidad de la detecci√≥n
                    if (detection.detection.score < 0.5) {
                        showNotification(
                            `‚ö†Ô∏è CALIDAD DE DETECCI√ìN BAJA (${(detection.detection.score * 100).toFixed(0)}%)\n\n` +
                            'El rostro se detect√≥ pero con baja confianza.\n\n' +
                            'Mejora:\n' +
                            '‚Ä¢ Aumenta la iluminaci√≥n\n' +
                            '‚Ä¢ Enfoca mejor la c√°mara\n' +
                            '‚Ä¢ Limpia el lente de la c√°mara\n' +
                            '‚Ä¢ Usa una foto de mayor calidad',
                            'error'
                        );
                        setProcessing(false);
                        setCapturedImage(null);
                        return;
                    }
                    
                    // Guardar registro
                    const registration = {
                        workerId: selectedWorker.id,
                        workerName: selectedWorker.nombre,
                        faceDescriptor: Array.from(detection.descriptor),
                        photoBase64: imageData,
                        registeredDate: new Date().toISOString(),
                        registeredBy: currentUser.usuario,
                        lastUpdated: new Date().toISOString(),
                        detectionScore: detection.detection.score
                    };
                    
                    const updatedRegistrations = {
                        ...registeredFaces,
                        [selectedWorker.id]: registration
                    };
                    
                    localStorage.setItem('face_registrations', JSON.stringify(updatedRegistrations));
                    setRegisteredFaces(updatedRegistrations);
                    
                    // IMPORTANTE: Actualizar tambi√©n app_users para que admin vea el cambio
                    const savedUsers = localStorage.getItem('app_users');
                    if (savedUsers) {
                        const users = JSON.parse(savedUsers);
                        const updatedUsers = users.map(u => 
                            u.id === selectedWorker.id 
                                ? {...u, has_face_registered: true}
                                : u
                        );
                        localStorage.setItem('app_users', JSON.stringify(updatedUsers));
                        setWorkers(updatedUsers); // Actualizar estado local tambi√©n
                    }
                    
                    showNotification(
                        `‚úÖ Rostro de ${selectedWorker.nombre} registrado exitosamente\n` +
                        `Calidad de detecci√≥n: ${(detection.detection.score * 100).toFixed(0)}%`,
                        'success'
                    );
                    
                    // Limpiar estado
                    setProcessing(false);
                    setCapturedImage(null);
                    setCaptureMode(null);
                    setSelectedWorker(null);
                    
                } catch (error) {
                    console.error('Error extrayendo descriptor:', error);
                    let errorMsg = '‚ùå ERROR PROCESANDO LA IMAGEN\n\n';
                    
                    if (error.message && error.message.includes('quota')) {
                        errorMsg += 'Memoria del navegador llena.\n\n' +
                                   'Soluci√≥n:\n' +
                                   '‚Ä¢ Limpia el cach√© del navegador\n' +
                                   '‚Ä¢ O usa fotos m√°s peque√±as (<500 KB)';
                    } else if (error.message && error.message.includes('network')) {
                        errorMsg += 'Error de conexi√≥n a internet.\n\n' +
                                   'Verifica tu conexi√≥n y recarga la p√°gina.';
                    } else {
                        errorMsg += 'Error t√©cnico al procesar el rostro.\n\n' +
                                   'Intenta:\n' +
                                   '‚Ä¢ Recargar la p√°gina (F5)\n' +
                                   '‚Ä¢ Usar otra foto\n' +
                                   '‚Ä¢ Probar en otro navegador';
                    }
                    
                    showNotification(errorMsg, 'error');
                    setProcessing(false);
                    setCapturedImage(null);
                }
            };

            // Eliminar registro
            const deleteRegistration = (workerId) => {
                if (!confirm('¬øEst√° seguro de eliminar este registro facial?')) return;
                
                const updated = { ...registeredFaces };
                delete updated[workerId];
                
                localStorage.setItem('face_registrations', JSON.stringify(updated));
                setRegisteredFaces(updated);
                
                // IMPORTANTE: Actualizar tambi√©n app_users
                const savedUsers = localStorage.getItem('app_users');
                if (savedUsers) {
                    const users = JSON.parse(savedUsers);
                    const updatedUsers = users.map(u => 
                        u.id === workerId 
                            ? {...u, has_face_registered: false}
                            : u
                    );
                    localStorage.setItem('app_users', JSON.stringify(updatedUsers));
                    setWorkers(updatedUsers);
                }
                
                showNotification('Registro facial eliminado', 'success');
            };

            // Cancelar captura
            const cancelCapture = () => {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    setStream(null);
                }
                setCaptureMode(null);
                setCapturedImage(null);
                setSelectedWorker(null);
                setProcessing(false);
            };

            if (!modelsLoaded) {
                return (
                    <div className="card">
                        <div className="card-header">
                            <h2 className="card-title">üë§ REGISTRO FACIAL</h2>
                        </div>
                        <div style={{padding: '60px 20px', textAlign: 'center'}}>
                            <div style={{fontSize: '48px', marginBottom: '20px'}}>‚è≥</div>
                            <h3 style={{color: '#2563eb', marginBottom: '10px'}}>Cargando sistema de reconocimiento facial...</h3>
                            <p style={{color: '#6b7280'}}>Por favor espere mientras se cargan los modelos de IA</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="card">
                    <div className="card-header">
                        <h2 className="card-title">üë§ REGISTRO FACIAL DE TRABAJADORES</h2>
                    </div>

                    {/* Estad√≠sticas */}
                    <div style={{padding: '20px', background: '#f8f9fa', borderBottom: '1px solid #e5e7eb'}}>
                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '20px'}}>
                            <div style={{textAlign: 'center'}}>
                                <div style={{fontSize: '32px', fontWeight: 'bold', color: '#2563eb'}}>{totalWorkers}</div>
                                <div style={{fontSize: '14px', color: '#6b7280'}}>Total Trabajadores</div>
                            </div>
                            <div style={{textAlign: 'center'}}>
                                <div style={{fontSize: '32px', fontWeight: 'bold', color: '#10b981'}}>{registeredCount}</div>
                                <div style={{fontSize: '14px', color: '#6b7280'}}>Registrados ({Math.round(registeredCount/totalWorkers*100)}%)</div>
                            </div>
                            <div style={{textAlign: 'center'}}>
                                <div style={{fontSize: '32px', fontWeight: 'bold', color: '#f59e0b'}}>{pendingCount}</div>
                                <div style={{fontSize: '14px', color: '#6b7280'}}>Pendientes</div>
                            </div>
                        </div>
                    </div>

                    {/* B√∫squeda */}
                    <div style={{padding: '20px', borderBottom: '1px solid #e5e7eb'}}>
                        <input
                            type="text"
                            placeholder="üîç Buscar trabajador por nombre o ID..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '12px 20px',
                                border: '2px solid #e5e7eb',
                                borderRadius: '8px',
                                fontSize: '15px'
                            }}
                        />
                    </div>

                    {/* Modal de captura */}
                    {captureMode && (
                        <div style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            background: 'rgba(0,0,0,0.8)',
                            display: 'flex',
                            justifyContent: 'center',
                            alignItems: 'center',
                            zIndex: 1000
                        }}>
                            <div style={{
                                background: 'white',
                                borderRadius: '15px',
                                padding: '30px',
                                maxWidth: '700px',
                                width: '90%',
                                maxHeight: '90vh',
                                overflow: 'auto'
                            }}>
                                <h3 style={{marginBottom: '20px', color: '#2563eb'}}>
                                    Registrar Rostro: {selectedWorker?.nombre}
                                </h3>

                                {!capturedImage ? (
                                    <>
                                        {captureMode === 'camera' && (
                                            <div style={{marginBottom: '20px'}}>
                                                <video
                                                    ref={videoRef}
                                                    autoPlay
                                                    playsInline
                                                    muted
                                                    style={{
                                                        width: '100%',
                                                        borderRadius: '10px',
                                                        background: '#000'
                                                    }}
                                                />
                                                <canvas ref={canvasRef} style={{display: 'none'}} />
                                            </div>
                                        )}
                                        
                                        <div style={{display: 'flex', gap: '10px', justifyContent: 'center'}}>
                                            {captureMode === 'camera' && (
                                                <button
                                                    className="btn btn-primary"
                                                    onClick={capturePhoto}
                                                    disabled={processing}
                                                >
                                                    üì∏ Capturar Foto
                                                </button>
                                            )}
                                            <button
                                                className="btn btn-secondary"
                                                onClick={cancelCapture}
                                                disabled={processing}
                                            >
                                                ‚ùå Cancelar
                                            </button>
                                        </div>
                                    </>
                                ) : (
                                    <>
                                        <div style={{marginBottom: '20px', textAlign: 'center'}}>
                                            {capturedImage && ( 
                                            <img
                                                src={capturedImage}
                                                alt="Captura"
                                                style={{
                                                maxWidth: '100%',
                                            borderRadius: '10px',
                                            boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
                                            }}
                                            />
                                            )}
                                        </div>
                                        
                                        {processing ? (
                                            <div style={{textAlign: 'center', padding: '20px'}}>
                                                <div style={{fontSize: '24px', marginBottom: '10px'}}>‚è≥</div>
                                                <p style={{color: '#6b7280'}}>Procesando y extrayendo caracter√≠sticas faciales...</p>
                                            </div>
                                        ) : (
                                            <div style={{display: 'flex', gap: '10px', justifyContent: 'center'}}>
                                                <button
                                                    className="btn btn-secondary"
                                                    onClick={cancelCapture}
                                                >
                                                    üîÑ Tomar Otra
                                                </button>
                                            </div>
                                        )}
                                    </>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Lista de trabajadores */}
                    <div style={{padding: '20px'}}>
                        <div style={{display: 'grid', gap: '15px'}}>
                            {filteredWorkers.map(worker => {
                                const isRegistered = registeredFaces[worker.id];
                                
                                return (
                                    <div
                                        key={worker.id}
                                        style={{
                                            border: '2px solid #e5e7eb',
                                            borderRadius: '12px',
                                            padding: '20px',
                                            background: isRegistered ? '#f0fdf4' : '#fff',
                                            borderColor: isRegistered ? '#10b981' : '#e5e7eb'
                                        }}
                                    >
                                        <div style={{display: 'flex', gap: '20px', alignItems: 'center', flexWrap: 'wrap'}}>
                                            {/* Foto */}
                                            <div style={{flexShrink: 0}}>
                                                {isRegistered?.photoBase64 && (
                                                <img
                                                    src={isRegistered.photoBase64}
                                                    alt={trabajador?.nombre || 'Trabajador'}
                                                style={{
                                                width: '100px',
                                                height: '100px',
                                                borderRadius: '50%',
                                                objectFit: 'cover',
                                                border: '3px solid #10b981'
                                                }}
                                                />
                                                )}                                                    
                                                <div style={{
                                                        width: '100px',
                                                        height: '100px',
                                                        borderRadius: '50%',
                                                        background: '#f3f4f6',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        justifyContent: 'center',
                                                        fontSize: '40px',
                                                        border: '3px solid #e5e7eb'
                                                    }}>
                                                        üë§
                                                    </div>
                                                )}
                                            </div>

                                            {/* Info */}
                                            <div style={{flex: 1, minWidth: '200px'}}>
                                                <div style={{fontSize: '18px', fontWeight: 'bold', color: '#1f2937', marginBottom: '5px'}}>
                                                    {worker.nombre}
                                                </div>
                                                <div style={{fontSize: '14px', color: '#6b7280', marginBottom: '8px'}}>
                                                    ID: {worker.id}
                                                </div>
                                                {isRegistered && (
                                                    <div style={{fontSize: '13px', color: '#10b981'}}>
                                                        ‚úÖ Registrado el {new Date(isRegistered.registeredDate).toLocaleDateString('es-ES')}
                                                    </div>
                                                )}
                                                {!isRegistered && (
                                                    <div style={{fontSize: '13px', color: '#f59e0b'}}>
                                                        ‚ö†Ô∏è Sin registro facial
                                                    </div>
                                                )}
                                            </div>

                                            {/* Acciones */}
                                            <div style={{display: 'flex', gap: '10px', flexWrap: 'wrap'}}>
                                                {!isRegistered ? (
                                                    <>
                                                        <button
                                                            className="btn btn-primary"
                                                            onClick={() => startCamera(worker)}
                                                            style={{fontSize: '14px', padding: '8px 16px'}}
                                                        >
                                                            üì∑ Tomar Foto
                                                        </button>
                                                        <button
                                                            className="btn btn-secondary"
                                                            onClick={() => fileInputRef.current?.click()}
                                                            style={{fontSize: '14px', padding: '8px 16px'}}
                                                        >
                                                            üìÅ Subir Archivo
                                                        </button>
                                                        <input
                                                            ref={fileInputRef}
                                                            type="file"
                                                            accept="image/*"
                                                            style={{display: 'none'}}
                                                            onChange={(e) => handleFileUpload(e, worker)}
                                                        />
                                                    </>
                                                ) : (
                                                    <>
                                                        <button
                                                            className="btn btn-warning"
                                                            onClick={() => startCamera(worker)}
                                                            style={{fontSize: '14px', padding: '8px 16px'}}
                                                        >
                                                            üîÑ Actualizar
                                                        </button>
                                                        <button
                                                            className="btn btn-danger"
                                                            onClick={() => deleteRegistration(worker.id)}
                                                            style={{fontSize: '14px', padding: '8px 16px'}}
                                                        >
                                                            ‚ùå Eliminar
                                                        </button>
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        // Componente de Login
        const LoginPage = ({ onLogin }) => {
            const { t, language, changeLanguage } = useTranslation();
            const [usuario, setUsuario] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                setError('');

                // Limpiar inputs
                const cleanUsuario = String(usuario).trim().toLowerCase();
                const cleanPassword = String(password).trim();

                // Verificar admin
                if (cleanUsuario === ADMIN_USER.usuario.toLowerCase() && cleanPassword === ADMIN_USER.password) {
                    onLogin({...ADMIN_USER, usuario: ADMIN_USER.usuario});
                    return;
                }

                // Verificar gerencia
                if (cleanUsuario === GERENCIA_USER.usuario.toLowerCase() && cleanPassword === GERENCIA_USER.password) {
                    onLogin({...GERENCIA_USER, usuario: GERENCIA_USER.usuario});
                    return;
                }

                // Cargar TODOS los usuarios (din√°micos + por defecto)
                const savedUsers = localStorage.getItem('app_users');
                let allUsers;
                
                if (savedUsers) {
                    // Si hay usuarios guardados, usar esos
                    allUsers = JSON.parse(savedUsers);
                } else {
                    // Si no hay usuarios guardados, inicializar con los por defecto
                    allUsers = COMPANY_DATA.trabajadores;
                    localStorage.setItem('app_users', JSON.stringify(allUsers));
                }
                
                // Buscar usuario (comparaci√≥n estricta y limpia)
                const worker = allUsers.find(w => {
                    const workerUser = String(w.usuario || '').trim().toLowerCase();
                    const workerPass = String(w.password || '').trim();
                    
                    return workerUser === cleanUsuario && workerPass === cleanPassword;
                });

                if (worker) {
                    onLogin({
                        id: worker.id,
                        name: worker.nombre,
                        role: worker.role || 'worker',
                        workerId: worker.id,
                        usuario: worker.usuario
                    });
                } else {
                    // Mostrar error m√°s detallado en desarrollo
                    console.log('Login fallido:', {
                        intentoUsuario: cleanUsuario,
                        intentoPassword: cleanPassword,
                        usuariosDisponibles: allUsers.map(u => ({
                            usuario: u.usuario,
                            passwordLength: (u.password || '').length,
                            id: u.id
                        }))
                    });
                    setError(t('login_error'));
                }
            };

            return (
                <div className="login-container">
                    <div className="login-box">
                        {/* Selector de idiomas en login - AMBOS VISIBLES */}
                        <div style={{
                            position: 'absolute',
                            top: '30px',
                            right: '30px',
                            display: 'flex',
                            gap: '12px',
                            zIndex: 1000
                        }}>
                            <button
                                onClick={() => changeLanguage('es')}
                                style={{
                                    background: language === 'es' ? '#10b981' : '#3b82f6',
                                    color: 'white',
                                    border: 'none',
                                    padding: '12px 20px',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '16px',
                                    fontWeight: '600',
                                    boxShadow: '0 4px 6px rgba(0,0,0,0.15)',
                                    transition: 'all 0.2s',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                    transform: language === 'es' ? 'scale(1.05)' : 'scale(1)'
                                }}
                            >
                                <span style={{fontSize: '22px'}}>üá™üá∏</span>
                                <span>Espa√±ol</span>
                            </button>
                            <button
                                onClick={() => changeLanguage('pt')}
                                style={{
                                    background: language === 'pt' ? '#10b981' : '#3b82f6',
                                    color: 'white',
                                    border: 'none',
                                    padding: '12px 20px',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '16px',
                                    fontWeight: '600',
                                    boxShadow: '0 4px 6px rgba(0,0,0,0.15)',
                                    transition: 'all 0.2s',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                    transform: language === 'pt' ? 'scale(1.05)' : 'scale(1)'
                                }}
                            >
                                <span style={{fontSize: '22px'}}>üáµüáπ</span>
                                <span>Portugu√™s</span>
                            </button>
                        </div>

                        <div className="login-title">{t('login_title')}</div>
                        <div className="login-subtitle">Sistema con Reconocimiento Facial y GPS</div>
                        
                        {error && <div className="error-message">{error}</div>}
                        
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">{t('login_user')}</label>
                                <input 
                                    type="text" 
                                    className="form-input"
                                    value={usuario}
                                    onChange={(e) => setUsuario(e.target.value)}
                                    required
                                />
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">{t('login_password')}</label>
                                <input 
                                    type="password" 
                                    className="form-input"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    required
                                />
                            </div>
                            
                            <button type="submit" className="btn btn-primary" style={{width: '100%', marginTop: '20px'}}>
                                {t('login_button')}
                            </button>
                        </form>

                        <div className="demo-credentials">
                            <strong>Usuarios Demo:</strong><br/>
                            Admin: admin / Admin@2025!Segura<br/>
                            Gerencia: gerencia / Gerencia@2025!Segura<br/>
                            Trabajador: adolfo.silva / 1234
                        </div>
                    </div>
                </div>
            );
        };

        // Componente de Notificaci√≥n
        const Notification = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 5000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const color = type === 'success' ? '#10b981' : '#ef4444';

            return (
                <div className="notification" style={{borderLeft: `4px solid ${color}`}}>
                    <span style={{fontSize: '20px', fontWeight: 'bold'}}>{type === 'success' ? '‚úì' : '‚úï'}</span>
                    <span style={{flex: 1}}>{message}</span>
                    <button onClick={onClose} style={{background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer'}}>√ó</button>
                </div>
            );
        };

        // NUEVO: Panel de Monitoreo Visual Mejorado
        const MonitoringDashboard = ({ clockings, absences, workers }) => {
            const [currentTime, setCurrentTime] = useState(new Date());
            
            // Actualizar cada 5 segundos
            useEffect(() => {
                const interval = setInterval(() => {
                    setCurrentTime(new Date());
                }, 5000);
                return () => clearInterval(interval);
            }, []);

            const getWorkerStatus = (workerId) => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // 1. Verificar ausencia HOY
                const todayStr = new Date().toISOString().split('T')[0];
                const absence = absences.find(a => {
                    const start = new Date(a.startDate).toISOString().split('T')[0];
                    const end = new Date(a.endDate).toISOString().split('T')[0];
                    return String(a.workerId) === String(workerId) && todayStr >= start && todayStr <= end;
                });
                
                if (absence) {
                    return {
                        status: 'orange',
                        text: 'AUSENTE',
                        subtitle: absence.reason || 'Baja m√©dica'
                    };
                }

                // 2. Verificar fichajes del d√≠a
                const todayClockings = clockings.filter(c => 
                    String(c.userId) === String(workerId) && 
                    new Date(c.timestamp) >= today
                );

                if (todayClockings.length === 0) {
                    return {
                        status: 'red',
                        text: 'SIN FICHAR',
                        subtitle: 'No ha fichado hoy'
                    };
                }

                const lastClocking = todayClockings[todayClockings.length - 1];
                
                if (lastClocking.type === 'in') {
                    // Calcular tiempo trabajado
                    const entryTime = new Date(lastClocking.timestamp);
                    const diff = currentTime - entryTime;
                    const hours = Math.floor(diff / 3600000);
                    const minutes = Math.floor((diff % 3600000) / 60000);
                    
                    return {
                        status: 'green',
                        text: 'TRABAJANDO',
                        subtitle: lastClocking.worksiteName,
                        time: `${hours}h ${minutes}m`,
                        entry: entryTime.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})
                    };
                } else {
                    return {
                        status: 'grey',
                        text: 'SALI√ì',
                        subtitle: lastClocking.worksiteName,
                        time: new Date(lastClocking.timestamp).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})
                    };
                }
            };

            // Contar estados
            const stats = {
                ausentes: 0,
                sinFichar: 0,
                trabajando: 0,
                salieron: 0
            };

            workers.forEach(w => {
                const status = getWorkerStatus(w.id);
                if (status.status === 'orange') stats.ausentes++;
                else if (status.status === 'red') stats.sinFichar++;
                else if (status.status === 'green') stats.trabajando++;
                else if (status.status === 'grey') stats.salieron++;
            });

            return (
                <div>
                    {/* Indicadores superiores - M√ÅS PEQUE√ëOS */}
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(4, 1fr)',
                        gap: '10px',
                        marginBottom: '20px',
                        maxWidth: '900px',
                        margin: '0 auto 20px auto'
                    }}>
                        {/* Ausentes */}
                        <div style={{
                            background: '#fff3cd',
                            border: '2px solid #ffc107',
                            borderRadius: '8px',
                            padding: '12px 8px',
                            textAlign: 'center'
                        }}>
                            <div style={{
                                fontSize: '28px',
                                fontWeight: 'bold',
                                color: '#856404',
                                lineHeight: '1'
                            }}>
                                {stats.ausentes}
                            </div>
                            <div style={{
                                fontSize: '12px',
                                fontWeight: '600',
                                color: '#856404',
                                marginTop: '4px'
                            }}>
                                AUSENTES
                            </div>
                        </div>

                        {/* Sin Fichar */}
                        <div style={{
                            background: '#f8d7da',
                            border: '2px solid #dc3545',
                            borderRadius: '8px',
                            padding: '12px 8px',
                            textAlign: 'center'
                        }}>
                            <div style={{
                                fontSize: '28px',
                                fontWeight: 'bold',
                                color: '#721c24',
                                lineHeight: '1'
                            }}>
                                {stats.sinFichar}
                            </div>
                            <div style={{
                                fontSize: '12px',
                                fontWeight: '600',
                                color: '#721c24',
                                marginTop: '4px'
                            }}>
                                SIN FICHAR
                            </div>
                        </div>

                        {/* Trabajando */}
                        <div style={{
                            background: '#d4edda',
                            border: '2px solid #28a745',
                            borderRadius: '8px',
                            padding: '12px 8px',
                            textAlign: 'center'
                        }}>
                            <div style={{
                                fontSize: '28px',
                                fontWeight: 'bold',
                                color: '#155724',
                                lineHeight: '1'
                            }}>
                                {stats.trabajando}
                            </div>
                            <div style={{
                                fontSize: '12px',
                                fontWeight: '600',
                                color: '#155724',
                                marginTop: '4px'
                            }}>
                                TRABAJANDO
                            </div>
                        </div>

                        {/* Salieron */}
                        <div style={{
                            background: '#e2e3e5',
                            border: '2px solid #6c757d',
                            borderRadius: '8px',
                            padding: '12px 8px',
                            textAlign: 'center'
                        }}>
                            <div style={{
                                fontSize: '28px',
                                fontWeight: 'bold',
                                color: '#383d41',
                                lineHeight: '1'
                            }}>
                                {stats.salieron}
                            </div>
                            <div style={{
                                fontSize: '12px',
                                fontWeight: '600',
                                color: '#383d41',
                                marginTop: '4px'
                            }}>
                                SALIERON
                            </div>
                        </div>
                    </div>

                    {/* Panel de trabajadores */}
                    <div className="card">
                        <div className="card-header" style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center'
                        }}>
                            <h2 className="card-title">PANEL DE MONITOREO EN TIEMPO REAL</h2>
                            <div style={{fontSize: '13px', color: '#6b7280'}}>
                                Actualizado: {currentTime.toLocaleTimeString('es-ES')}
                            </div>
                        </div>
                        <div className="monitor-grid">
                            {workers.map(worker => {
                                const status = getWorkerStatus(worker.id);
                                return (
                                    <div key={worker.id} className={`worker-monitor-card status-${status.status}`}>
                                        <div className="worker-monitor-photo"></div>
                                        <div className="worker-monitor-name">{worker.nombre}</div>
                                        <div className="worker-monitor-id">ID: {worker.id}</div>
                                        
                                        <button className="status-button">
                                            {status.text}
                                        </button>
                                        
                                        <div style={{
                                            fontSize: '12px',
                                            color: '#6b7280',
                                            marginTop: '8px',
                                            textAlign: 'center'
                                        }}>
                                            {status.subtitle}
                                        </div>
                                        
                                        {status.time && (
                                            <div style={{
                                                fontSize: '14px',
                                                fontWeight: '600',
                                                color: '#1f2937',
                                                marginTop: '4px',
                                                textAlign: 'center'
                                            }}>
                                                {status.entry ? `Entrada: ${status.entry}` : status.time}
                                                {status.entry && <div style={{fontSize: '12px', marginTop: '2px'}}>{status.time}</div>}
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        // NUEVO: Gesti√≥n de Ausencias
        const AbsenceManagement = ({ absences, onUpdate }) => {
            const [selectedWorker, setSelectedWorker] = useState('');
            const [reason, setReason] = useState('');
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');

            const addAbsence = () => {
                if (!selectedWorker || !reason || !startDate) {
                    alert('Completa: Trabajador, Motivo y Fecha Inicio');
                    return;
                }

                const finalEndDate = endDate || startDate;

                if (new Date(finalEndDate) < new Date(startDate)) {
                    alert('La fecha de fin no puede ser anterior a la de inicio');
                    return;
                }

                onUpdate([...absences, {
                    id: Date.now(),
                    workerId: parseInt(selectedWorker),
                    reason: reason,
                    startDate: new Date(startDate),
                    endDate: new Date(finalEndDate),
                    registeredAt: new Date()
                }]);

                setSelectedWorker('');
                setReason('');
                setStartDate('');
                setEndDate('');
            };

            const removeAbsence = (absenceId) => {
                onUpdate(absences.filter(a => a.id !== absenceId));
            };

            const getDays = (start, end) => {
                const oneDay = 24 * 60 * 60 * 1000;
                return Math.round(Math.abs((end - start) / oneDay)) + 1;
            };

            const exportToExcel = () => {
                if (absences.length === 0) {
                    alert('No hay ausencias para exportar');
                    return;
                }

                const excelData = absences.map(absence => {
                    const worker = COMPANY_DATA.trabajadores.find(w => w.id === absence.workerId);
                    const days = getDays(new Date(absence.startDate), new Date(absence.endDate));
                    
                    return {
                        'ID': absence.workerId,
                        'Trabajador': worker?.nombre || 'Desconocido',
                        'Motivo': absence.reason,
                        'Fecha Inicio': new Date(absence.startDate).toLocaleDateString('es-ES'),
                        'Fecha Fin': new Date(absence.endDate).toLocaleDateString('es-ES'),
                        'D√≠as': days,
                        'Registrado': new Date(absence.registeredAt).toLocaleString('es-ES')
                    };
                });

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                const colWidths = [
                    { wch: 8 },   // ID
                    { wch: 30 },  // Trabajador
                    { wch: 20 },  // Motivo
                    { wch: 12 },  // Fecha Inicio
                    { wch: 12 },  // Fecha Fin
                    { wch: 8 },   // D√≠as
                    { wch: 18 }   // Registrado
                ];
                ws['!cols'] = colWidths;
                
                XLSX.utils.book_append_sheet(wb, ws, 'Ausencias');
                
                const fileName = `Ausencias_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
            };

            return (
                <div className="card">
                    <div className="card-header">
                        <h2 className="card-title">Gesti√≥n de Ausencias</h2>
                        <button 
                            className="btn btn-success" 
                            onClick={exportToExcel}
                            disabled={absences.length === 0}
                            style={{opacity: absences.length === 0 ? 0.5 : 1, cursor: absences.length === 0 ? 'not-allowed' : 'pointer'}}
                        >
                            Exportar Excel {absences.length > 0 && `(${absences.length})`}
                        </button>
                    </div>

                    <div className="form-group">
                        <label className="form-label">Trabajador:</label>
                        <select 
                            className="form-select"
                            value={selectedWorker}
                            onChange={(e) => setSelectedWorker(e.target.value)}
                        >
                            <option value="">-- Selecciona --</option>
                            {COMPANY_DATA.trabajadores.map(w => (
                                <option key={w.id} value={w.id}>{w.nombre}</option>
                            ))}
                        </select>
                    </div>

                    <div className="form-group">
                        <label className="form-label">Motivo:</label>
                        <select 
                            className="form-select"
                            value={reason}
                            onChange={(e) => setReason(e.target.value)}
                        >
                            <option value="">-- Selecciona --</option>
                            <option value="Vacaciones">Vacaciones</option>
                            <option value="Baja m√©dica">Baja m√©dica</option>
                            <option value="Permiso personal">Permiso personal</option>
                            <option value="Falta justificada">Falta justificada</option>
                            <option value="Falta injustificada">Falta injustificada</option>
                        </select>
                    </div>

                    <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px'}}>
                        <div className="form-group">
                            <label className="form-label">Desde:</label>
                            <input
                                type="date"
                                className="form-select"
                               value={startDate || ''}
                            onChange={(e) => setStartDate(e.target.value)}
                            />
                        </div>

                        <div className="form-group">
                            <label className="form-label">Hasta:</label>
                            <input
                                type="date"
                                className="form-select"
                                value={endDate || ''}
                            onChange={(e) => setStartDate(e.target.value)}
                            />
                            {!endDate && startDate && (
                                <div style={{fontSize: '12px', color: '#6b7280', marginTop: '5px'}}>
                                    Opcional: d√©jalo vac√≠o si es un solo d√≠a
                                </div>
                            )}
                        </div>
                    </div>

                    <button className="btn btn-primary btn-large" onClick={addAbsence}>
                        Registrar Ausencia
                    </button>

                    {absences.length > 0 && (
                        <div style={{marginTop: '30px'}}>
                            <h3 style={{marginBottom: '15px'}}>Ausencias Registradas ({absences.length}):</h3>
                            {absences.map(absence => {
                                const worker = COMPANY_DATA.trabajadores.find(w => w.id === absence.workerId);
                                const days = getDays(new Date(absence.startDate), new Date(absence.endDate));
                                
                                return (
                                    <div key={absence.id} style={{
                                        padding: '15px',
                                        background: '#fef3c7',
                                        borderRadius: '8px',
                                        marginBottom: '10px',
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center'
                                    }}>
                                        <div>
                                            <strong style={{fontSize: '15px'}}>{worker?.nombre}</strong><br/>
                                            <span style={{fontSize: '13px', color: '#92400e', fontWeight: '500'}}>
                                                {absence.reason}
                                            </span><br/>
                                            <span style={{fontSize: '13px', color: '#78716c'}}>
                                                {new Date(absence.startDate).toLocaleDateString('es-ES')}
                                                {' ‚Üí '}
                                                {new Date(absence.endDate).toLocaleDateString('es-ES')}
                                                {days > 1 && ` (${days} d√≠as)`}
                                            </span>
                                        </div>
                                        <button 
                                            className="btn btn-danger"
                                            onClick={() => removeAbsence(absence.id)}
                                        >
                                            Eliminar
                                        </button>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        };

        // NUEVO: App Trabajador con QR Permanente
        const WorkerApp = ({ user, clockings, onClocking }) => {
            const { t } = useTranslation();
            const [workerQR, setWorkerQR] = useState(null);
            const [step, setStep] = useState('init'); // init, ready, scanning, processing, success
            const [selectedObra, setSelectedObra] = useState('');
            const [gpsLocation, setGpsLocation] = useState(null);
            const [successData, setSuccessData] = useState(null);
            const videoRef = useRef(null);
            const streamRef = useRef(null);

            useEffect(() => {
                // Verificar si ya tiene QR guardado
                const savedQR = localStorage.getItem(`worker_qr_${user.workerId}`);
                if (savedQR) {
                    setWorkerQR(JSON.parse(savedQR));
                    setStep('ready');
                } else {
                    // Generar y guardar QR autom√°ticamente
                    const qrData = {
                        workerId: user.workerId,
                        name: user.name,
                        generatedAt: new Date()
                    };
                    localStorage.setItem(`worker_qr_${user.workerId}`, JSON.stringify(qrData));
                    setWorkerQR(qrData);
                    setStep('first-time');
                    
                    // Generar QR visual
                    setTimeout(() => {
                        const container = document.getElementById('my-qr-code');
                        if (container && container.innerHTML === '') {
                            new QRCode(container, {
                                text: `WORKER-${user.workerId}`,
                                width: 200,
                                height: 200
                            });
                        }
                    }, 100);
                }
            }, [user]);

            // CONFIGURACI√ìN SISTEMA DUAL
            const FACE_CONFIG = {
                mode: 'hybrid',  // 'disabled', 'photo-only', 'hybrid', 'required'
                randomPercentage: 15,  // 15% con reconocimiento facial completo
                alwaysTakePhoto: true,  // Siempre toma foto (sin AI procesamiento)
                photoQuality: 0.7  // Calidad JPEG para fotos simples
            };

            // Funci√≥n para tomar foto r√°pida (SIN reconocimiento facial)
            const takeQuickPhoto = async () => {
                console.log('üì∏ Iniciando captura r√°pida de foto...');
                
                try {
                    // Activar c√°mara
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: 'user'
                        }
                    });

                    const video = document.createElement('video');
                    video.srcObject = stream;
                    video.setAttribute('autoplay', '');
                    video.setAttribute('muted', '');
                    video.setAttribute('playsinline', '');
                    
                    await new Promise((resolve) => {
                        video.onloadedmetadata = () => {
                            video.play();
                            resolve();
                        };
                    });

                    // Esperar 300ms para estabilizar
                    await new Promise(resolve => setTimeout(resolve, 300));

                    // Capturar frame
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0);

                    // Detener c√°mara INMEDIATAMENTE
                    stream.getTracks().forEach(track => {
                        track.stop();
                        console.log('üìπ C√°mara detenida (foto r√°pida)');
                    });

                    // Convertir a base64
                    const photoBase64 = canvas.toDataURL('image/jpeg', FACE_CONFIG.photoQuality);
                    
                    console.log('‚úÖ Foto capturada (sin procesamiento AI)');
                    
                    return {
                        success: true,
                        photo: photoBase64,
                        timestamp: new Date().toISOString()
                    };
                    
                } catch (error) {
                    console.error('‚ùå Error capturando foto:', error);
                    throw error;
                }
            };

            // Funci√≥n de fichaje r√°pido (FOTO SIMPLE)
            const quickClocking = async () => {
                if (!selectedObra) {
                    alert('Selecciona una obra primero');
                    return;
                }

                // ============================================
                // PASO 1: OBTENER GPS PRIMERO
                // ============================================
                setStep('validating');
                console.log('üìç PASO 1: Solicitando ubicaci√≥n GPS...');

                try {
                    // Pedir GPS con timeout extendido (15 segundos)
                    const gpsPosition = await new Promise((resolve, reject) => {
                        if (!navigator.geolocation) {
                            reject(new Error('GPS no disponible en este dispositivo'));
                            return;
                        }
                        
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                const location = {
                                    lat: position.coords.latitude,
                                    lng: position.coords.longitude,
                                    accuracy: position.coords.accuracy
                                };
                                console.log('‚úÖ GPS obtenido:', location);
                                resolve(location);
                            },
                            (error) => {
                                console.error('‚ùå Error GPS:', error);
                                let errorMsg = 'No se pudo obtener ubicaci√≥n GPS';
                                if (error.code === 1) errorMsg = 'Permiso GPS DENEGADO';
                                if (error.code === 2) errorMsg = 'Ubicaci√≥n no disponible';
                                if (error.code === 3) errorMsg = 'Tiempo agotado obteniendo GPS';
                                reject(new Error(errorMsg));
                            },
                            { 
                                enableHighAccuracy: true,
                                timeout: 15000,  // 15 segundos
                                maximumAge: 0
                            }
                        );
                    });
                    
                    console.log('üìç GPS obtenido exitosamente:', gpsPosition);
                    
                    // ============================================
                    // PASO 2: VALIDAR RANGO GPS
                    // ============================================
                    console.log('üîç PASO 2: Validando rango GPS...');
                    
                    // Cargar configuraci√≥n GPS
                    const gpsConfigStr = localStorage.getItem('gps_config');
                    const gpsConfig = gpsConfigStr ? JSON.parse(gpsConfigStr) : DEFAULT_GPS_CONFIG;
                    
                    // CARGAR OBRAS DESDE SUPABASE (NO localStorage)
                    let obrasGPS;
                    try {
                        console.log('üìç Cargando obras desde Supabase...');
                        const result = await supabase.from('worksites').select('*');
                        
                        if (result.data && result.data.length > 0) {
                            obrasGPS = result.data.map(w => ({
                                id: w.id.toString(),
                                nombre_obra: w.nombre,
                                lat: parseFloat(w.latitude),
                                lng: parseFloat(w.longitude),
                                radius: w.radio_metros || 100
                            }));
                            console.log('‚úÖ Obras cargadas desde Supabase:', obrasGPS.length);
                        } else {
                            throw new Error('No hay obras en Supabase');
                        }
                    } catch (error) {
                        console.error('‚ùå Error cargando desde Supabase:', error);
                        // Fallback a localStorage solo si Supabase falla
                        const obrasStr = localStorage.getItem('gps_obras');
                        obrasGPS = obrasStr ? JSON.parse(obrasStr) : COMPANY_DATA.obras;
                        console.log('‚ö†Ô∏è Usando fallback localStorage/COMPANY_DATA');
                    }
                    
                    // Buscar obra por NOMBRE (ya que ahora selectedObra guarda el nombre)
                    console.log('üîç Buscando obra:', selectedObra);
                    console.log('üìã Obras disponibles:', obrasGPS.map(o => o.nombre_obra));
                    
                    const selectedObraGPS = obrasGPS.find(o => o.nombre_obra === selectedObra);
                    
                    if (!selectedObraGPS) {
                        throw new Error(`No se encontr√≥ la obra "${selectedObra}"\n\nIntenta de nuevo.`);
                    }
                    
                    if (!selectedObraGPS.lat || !selectedObraGPS.lng) {
                        throw new Error(`La obra "${selectedObraGPS.nombre_obra}" no tiene coordenadas GPS\n\nConfigura GPS en panel Admin.`);
                    }
                    
                    console.log('‚úÖ Obra encontrada:', selectedObraGPS.nombre_obra);
                    console.log('üìç Coordenadas obra:', selectedObraGPS.lat, selectedObraGPS.lng);
                    
                    // Calcular distancia
                    const distance = calculateDistance(
                        gpsPosition.lat,
                        gpsPosition.lng,
                        selectedObraGPS.lat,
                        selectedObraGPS.lng
                    );
                    
                    console.log(`üìè Distancia calculada: ${distance.toFixed(0)}m`);
                    console.log(`üìç Radio permitido: ${selectedObraGPS.radius}m`);
                    console.log(`üèóÔ∏è Obra: ${selectedObraGPS.nombre_obra}`);
                    console.log(`üìå Coordenadas obra: lat=${selectedObraGPS.lat}, lng=${selectedObraGPS.lng}`);
                    console.log(`üìå Coordenadas usuario: lat=${gpsPosition.lat}, lng=${gpsPosition.lng}`);
                    
                    const isWithinRange = distance <= selectedObraGPS.radius;
                    
                    // Validaci√≥n GPS seg√∫n configuraci√≥n
                    if (gpsConfig.enabled && gpsConfig.mode === 'block' && !isWithinRange) {
                        alert(`üö´ FUERA DE RANGO\n\nDebes estar en la obra para fichar.\n\nObra: ${selectedObraGPS.nombre_obra}\nDistancia: ${distance.toFixed(0)}m\nM√°ximo: ${selectedObraGPS.radius}m\n\n‚ö†Ô∏è Ac√©rcate a la obra e intenta de nuevo.`);
                        setStep('ready');
                        return;
                    }
                    
                    if (gpsConfig.enabled && gpsConfig.mode === 'alert' && !isWithinRange) {
                        const confirm = window.confirm(`‚ö†Ô∏è ALERTA: Est√°s LEJOS de la obra\n\nObra: ${selectedObraGPS.nombre_obra}\nDistancia: ${distance.toFixed(0)}m\nM√°ximo: ${selectedObraGPS.radius}m\n\n¬øConfirmar fichaje de todas formas?`);
                        if (!confirm) {
                            setStep('ready');
                            return;
                        }
                    }
                    
                    console.log('‚úÖ GPS validado correctamente');
                    
                    // ============================================
                    // PASO 3: AHORA S√ç - TOMAR FOTO
                    // ============================================
                    console.log('üì∏ PASO 3: Capturando foto...');
                    setStep('camera');
                    
                    const photoResult = await takeQuickPhoto();
                    
                    console.log('‚úÖ Foto capturada exitosamente');
                    
                    // ============================================
                    // PASO 4: REGISTRAR FICHAJE
                    // ============================================
                    console.log('üíæ PASO 4: Registrando fichaje...');
                    setStep('validating');
                    
                    registerClocking(gpsPosition, false, 0, photoResult.photo);

                } catch (error) {
                    console.error('‚ùå Error en fichaje r√°pido:', error);
                    
                    let errorMsg = '‚ùå ERROR EN EL FICHAJE\n\n';
                    
                    if (error.message.includes('GPS')) {
                        errorMsg += `${error.message}\n\nAseg√∫rate de:\n‚Ä¢ Activar GPS/ubicaci√≥n en tu dispositivo\n‚Ä¢ Dar permisos de ubicaci√≥n al navegador\n‚Ä¢ Estar en exteriores o cerca de ventanas`;
                    } else if (error.name === 'NotAllowedError') {
                        errorMsg += 'Permiso de c√°mara DENEGADO.\n\nDebes permitir el acceso a la c√°mara.';
                    } else {
                        errorMsg += `${error.message}\n\nIntenta de nuevo.`;
                    }
                    
                    alert(errorMsg);
                    setStep('ready');
                }
            };

            const startFaceRecognition = async () => {
                if (!selectedObra) {
                    alert('Selecciona una obra primero');
                    return;
                }

                setStep('processing');

                try {
                    // Timeout de 30 segundos
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('TIMEOUT')), 30000)
                    );

                    const recognitionPromise = (async () => {
                        // 1. Verificar que el trabajador tiene rostro registrado
                        const savedRegistrations = localStorage.getItem('face_registrations') || '{}';
                        const registrations = JSON.parse(savedRegistrations);
                        const workerRegistration = registrations[user.workerId];
                        
                        if (!workerRegistration) {
                            throw new Error('NO_FACE_REGISTERED');
                        }

                        setStep('camera');

                        // 2. Activar c√°mara
                        const stream = await navigator.mediaDevices.getUserMedia({
                            video: {
                                width: { ideal: 640 },
                                height: { ideal: 480 },
                                facingMode: 'user'
                            }
                        });

                        // 3. Capturar foto
                        const video = document.createElement('video');
                        video.srcObject = stream;
                        video.setAttribute('autoplay', '');
                        video.setAttribute('muted', '');
                        video.setAttribute('playsinline', '');
                        
                        await new Promise((resolve) => {
                            video.onloadedmetadata = () => {
                                video.play();
                                resolve();
                            };
                        });

                        // Esperar estabilizaci√≥n
                        await new Promise(resolve => setTimeout(resolve, 500));

                        const canvas = document.createElement('canvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, 0, 0);

                        // Ajustar brillo si necesario
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        let avgBrightness = 0;
                        for (let i = 0; i < imageData.data.length; i += 4) {
                            avgBrightness += (imageData.data[i] + imageData.data[i+1] + imageData.data[i+2]) / 3;
                        }
                        avgBrightness = avgBrightness / (imageData.data.length / 4);
                        
                        console.log(`üì∏ Brillo: ${avgBrightness.toFixed(0)}`);
                        
                        if (avgBrightness < 100) {
                            console.log('üí° Aumentando brillo...');
                            for (let i = 0; i < imageData.data.length; i += 4) {
                                imageData.data[i] = Math.min(255, imageData.data[i] * 1.5);
                                imageData.data[i+1] = Math.min(255, imageData.data[i+1] * 1.5);
                                imageData.data[i+2] = Math.min(255, imageData.data[i+2] * 1.5);
                            }
                            ctx.putImageData(imageData, 0, 0);
                        }

                        // ‚ö†Ô∏è IMPORTANTE: Detener stream INMEDIATAMENTE
                        stream.getTracks().forEach(track => {
                            track.stop();
                            console.log('üìπ C√°mara detenida');
                        });

                        setStep('processing');

                        // 4. Detectar rostro
                        console.log('üîç Detectando rostro...');
                        const detection = await faceapi
                            .detectSingleFace(canvas, new faceapi.TinyFaceDetectorOptions({
                                inputSize: 224,
                                scoreThreshold: 0.25
                            }))
                            .withFaceLandmarks()
                            .withFaceDescriptor();

                        if (!detection) {
                            console.error('‚ùå No se detect√≥ rostro');
                            throw new Error('NO_FACE_DETECTED');
                        }

                        console.log(`‚úÖ Rostro detectado: ${(detection.detection.score * 100).toFixed(1)}%`);

                        // 5. Comparar con el descriptor registrado
                        const savedDescriptor = new Float32Array(workerRegistration.faceDescriptor);
                        const currentDescriptor = detection.descriptor;
                        
                        const distance = faceapi.euclideanDistance(savedDescriptor, currentDescriptor);
                        const similarity = 1 - distance;

                        console.log(`‚úì Similitud: ${(similarity * 100).toFixed(2)}%`);

                        return { similarity, canvas, avgBrightness };
                    })();

                    // Ejecutar con timeout
                    const { similarity, canvas, avgBrightness } = await Promise.race([
                        recognitionPromise,
                        timeoutPromise
                    ]);

                    // 6. Validar similitud
                    if (similarity < 0.6) {
                        // Registrar intento de fraude
                        const photoBase64 = canvas.toDataURL('image/jpeg', 0.8);
                        const fraudAttempt = {
                            id: Date.now(),
                            workerId: user.workerId,
                            workerName: user.name,
                            timestamp: new Date().toISOString(),
                            similarity: similarity,
                            photoBase64: photoBase64,
                            blocked: true
                        };
                        
                        const savedFrauds = localStorage.getItem('fraud_attempts') || '[]';
                        const frauds = JSON.parse(savedFrauds);
                        frauds.push(fraudAttempt);
                        localStorage.setItem('fraud_attempts', JSON.stringify(frauds));
                        
                        alert(`üö´ ACCESO DENEGADO\n\nRostro no reconocido\nSimilitud: ${(similarity * 100).toFixed(1)}%\nM√≠nimo: 60%\n\nEste intento ha sido registrado.`);
                        setStep('ready');
                        return;
                    }

                    const photoBase64 = canvas.toDataURL('image/jpeg', 0.8);

                    // 7. Obtener GPS (OBLIGATORIO)
                    console.log('üìç Obteniendo ubicaci√≥n GPS...');
                    
                    const gpsPosition = await new Promise((resolve, reject) => {
                        if (!navigator.geolocation) {
                            reject(new Error('GPS no disponible'));
                            return;
                        }
                        
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                const location = {
                                    lat: position.coords.latitude,
                                    lng: position.coords.longitude,
                                    accuracy: position.coords.accuracy
                                };
                                console.log('‚úÖ GPS obtenido:', location);
                                resolve(location);
                            },
                            (error) => {
                                console.error('‚ùå Error GPS:', error);
                                let errorMsg = 'Error obteniendo GPS';
                                if (error.code === 1) errorMsg = 'Permiso GPS DENEGADO';
                                if (error.code === 2) errorMsg = 'Ubicaci√≥n no disponible';
                                if (error.code === 3) errorMsg = 'Tiempo agotado - Activa GPS y reintenta';
                                reject(new Error(errorMsg));
                            },
                            { 
                                enableHighAccuracy: true,
                                timeout: 15000,  // 15 segundos
                                maximumAge: 0
                            }
                        );
                    });
                    
                    setGpsLocation(gpsPosition);
                    registerClocking(gpsPosition, true, similarity, photoBase64);

                } catch (error) {
                    console.error('Error en reconocimiento facial:', error);
                    
                    // Detener cualquier stream activo
                    navigator.mediaDevices.getUserMedia({ video: true })
                        .then(stream => stream.getTracks().forEach(track => track.stop()))
                        .catch(() => {});
                    
                    let errorMsg = 'Error desconocido';
                    
                    if (error.message === 'TIMEOUT') {
                        errorMsg = '‚è±Ô∏è TIEMPO AGOTADO\n\nEl reconocimiento tard√≥ demasiado.\n\nIntenta de nuevo con:\n‚Ä¢ Mejor iluminaci√≥n\n‚Ä¢ Rostro m√°s cerca\n‚Ä¢ C√°mara estable';
                    } else if (error.message === 'NO_FACE_REGISTERED') {
                        errorMsg = '‚ùå Tu rostro NO est√° registrado\n\nContacta con el administrador para registrarte.';
                    } else if (error.message === 'NO_FACE_DETECTED') {
                        errorMsg = '‚ùå NO SE DETECT√ì ROSTRO\n\n‚Ä¢ Iluminaci√≥n frontal\n‚Ä¢ Rostro de frente\n‚Ä¢ Sin gafas de sol';
                    } else if (error.name === 'NotAllowedError') {
                        errorMsg = '‚ùå Permiso de c√°mara DENEGADO\n\nDebes permitir el acceso a la c√°mara.';
                    } else if (error.message && error.message.includes('GPS')) {
                        errorMsg = `‚ùå ERROR GPS\n\n${error.message}\n\nAseg√∫rate de:\n‚Ä¢ Activar GPS/ubicaci√≥n\n‚Ä¢ Dar permisos al navegador\n‚Ä¢ Estar en exteriores`;
                    } else {
                        errorMsg = `‚ùå ERROR\n\n${error.message}\n\nRecarga la p√°gina e intenta de nuevo.`;
                    }
                    
                    alert(errorMsg);
                    setStep('ready');
                }
            };

            const registerClocking = (location, faceRecognized = false, similarity = 0, photoBase64 = null) => {
                // ============================================
                // VALIDACI√ìN GPS OBLIGATORIA
                // ============================================
                if (!location || location.lat === null || location.lng === null) {
                    alert('‚ùå ERROR: No se pudo obtener ubicaci√≥n GPS\n\nEl fichaje requiere GPS v√°lido.\n\nAseg√∫rate de:\n‚Ä¢ Activar GPS/ubicaci√≥n\n‚Ä¢ Dar permisos al navegador');
                    setStep('ready');
                    return;
                }
                
                console.log('‚úÖ GPS v√°lido para registro:', location);
                
                // Cargar configuraci√≥n GPS
                const gpsConfigStr = localStorage.getItem('gps_config');
                const gpsConfig = gpsConfigStr ? JSON.parse(gpsConfigStr) : DEFAULT_GPS_CONFIG;
                
                // CR√çTICO: Cargar obras SIEMPRE de localStorage (coordenadas guardadas)
                const obrasStr = localStorage.getItem('gps_obras');
                let obrasGPS;
                
                if (obrasStr) {
                    // Usar obras guardadas en localStorage (con coordenadas)
                    obrasGPS = JSON.parse(obrasStr);
                    console.log('üìç Usando coordenadas de localStorage');
                } else {
                    // Fallback: copiar COMPANY_DATA a localStorage
                    obrasGPS = COMPANY_DATA.obras;
                    localStorage.setItem('gps_obras', JSON.stringify(obrasGPS));
                    console.warn('‚ö†Ô∏è Copiando obras a localStorage (primera vez)');
                }
                
                // Determinar qu√© tipo de fichaje es
                const userClockings = clockings.filter(c => c.userId === user.workerId);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayClockings = userClockings.filter(c => new Date(c.timestamp) >= today);
                const lastClocking = todayClockings.length > 0 ? todayClockings[todayClockings.length - 1] : null;
                
                const type = (!lastClocking || lastClocking.type === 'out') ? 'in' : 'out';
                
                // CR√çTICO: Determinar obra correcta seg√∫n tipo
                let obra;
                if (type === 'in') {
                    // ENTRADA: Usar obra seleccionada por usuario (ahora selectedObra es el NOMBRE)
                    obra = obrasGPS.find(o => o.nombre_obra === selectedObra);
                    console.log(`üö™ ENTRADA: Buscando obra "${selectedObra}"`);
                } else {
                    // SALIDA: Usar MISMA obra donde entr√≥ (√∫ltima entrada)
                    if (lastClocking && lastClocking.worksite) {
                        // worksite puede ser ID o nombre, intentar ambos
                        obra = obrasGPS.find(o => 
                            o.id === lastClocking.worksite || 
                            o.nombre_obra === lastClocking.worksite
                        );
                        console.log(`üö™ SALIDA: Validando GPS en obra de entrada: ${obra?.nombre_obra}`);
                    } else {
                        // Fallback: usar obra seleccionada
                        obra = obrasGPS.find(o => o.nombre_obra === selectedObra);
                        console.warn('‚ö†Ô∏è No se encontr√≥ obra de entrada, usando seleccionada');
                    }
                }
                
                if (!obra) {
                    console.error('‚ùå No se encontr√≥ la obra');
                    console.error('selectedObra:', selectedObra);
                    console.error('obrasGPS:', obrasGPS);
                    alert('‚ùå Error: No se pudo determinar la obra\n\nObra buscada: ' + selectedObra);
                    setStep('ready');
                    return;
                }
                
                // Debug: Verificar coordenadas de la obra
                console.log(`üìç Obra: ${obra.nombre_obra}`);
                console.log(`üìç Coordenadas obra: lat=${obra.lat}, lng=${obra.lng}`);
                console.log(`üìç Coordenadas usuario: lat=${location.lat}, lng=${location.lng}`);
                
                // VALIDACI√ìN GPS
                if (gpsConfig.enabled && obra.lat && obra.lng && location.lat && location.lng) {
                    const distance = calculateDistance(
                        location.lat,
                        location.lng,
                        obra.lat,
                        obra.lng
                    );
                    
                    const inRange = distance <= obra.radius;
                    
                    console.log(`üìç Validaci√≥n GPS:
                        Tipo: ${type === 'in' ? 'ENTRADA' : 'SALIDA'}
                        Obra: ${obra.nombre_obra}
                        Coords Obra: ${obra.lat}, ${obra.lng}
                        Coords Trabajador: ${location.lat}, ${location.lng}
                        Distancia: ${distance.toFixed(0)}m
                        Radio permitido: ${obra.radius}m
                        Estado: ${inRange ? '‚úÖ DENTRO' : '‚ùå FUERA'}`
                    );
                    
                    if (!inRange) {
                        // Fuera de rango
                        if (gpsConfig.mode === 'block') {
                            // Modo bloqueo: NO permite fichar
                            alert(
                                `üö´ FICHAJE BLOQUEADO\n\n` +
                                `No puedes fichar ${type === 'in' ? 'ENTRADA' : 'SALIDA'} desde tu ubicaci√≥n actual.\n\n` +
                                `üìç Obra: ${obra.nombre_obra}\n` +
                                `üìè Distancia: ${distance.toFixed(0)} metros\n` +
                                `‚úì Permitido: ${obra.radius} metros\n\n` +
                                (type === 'out' ? 
                                    `‚ö†Ô∏è Debes estar en la MISMA obra donde entraste para registrar salida.\n\n` : 
                                    ''
                                ) +
                                `Debes estar a ${obra.radius}m o menos de la obra.`
                            );
                            setStep('ready');
                            return;
                        } else {
                            // Modo alerta: Permite pero avisa
                            const confirmar = confirm(
                                `‚ö†Ô∏è UBICACI√ìN FUERA DE RANGO\n\n` +
                                `Est√°s lejos de "${obra.nombre_obra}"\n\n` +
                                `üìè Distancia: ${distance.toFixed(0)} metros\n` +
                                `‚úì Rango normal: ${obra.radius} metros\n\n` +
                                (type === 'out' ? 
                                    `‚ö†Ô∏è IMPORTANTE: Deber√≠as estar en la misma obra donde entraste.\n\n` : 
                                    ''
                                ) +
                                `Este fichaje ser√° marcado como "Fuera de rango".\n\n` +
                                `¬øDeseas continuar de todas formas?`
                            );
                            
                            if (!confirmar) {
                                setStep('ready');
                                return;
                            }
                        }
                    }
                }

                // Calcular distancia para guardarla en el registro
                let distanceToWorksite = null;
                if (obra.lat && obra.lng && location.lat && location.lng) {
                    distanceToWorksite = calculateDistance(
                        location.lat,
                        location.lng,
                        obra.lat,
                        obra.lng
                    );
                    
                    console.log(`üìè Distancia calculada: ${distanceToWorksite.toFixed(0)}m`);
                    
                    // ALERTA: Si la distancia es superior a 5km, las coordenadas pueden estar mal configuradas
                    if (distanceToWorksite > 5000) {
                        console.error(`‚ö†Ô∏è ALERTA: Distancia muy grande (${distanceToWorksite.toFixed(0)}m / ${(distanceToWorksite/1000).toFixed(1)}km)`);
                        console.error(`‚ö†Ô∏è Posibles causas:`);
                        console.error(`   1. Coordenadas de obra mal configuradas`);
                        console.error(`   2. GPS del celular impreciso`);
                        console.error(`   3. Obra registrada desde otra ubicaci√≥n`);
                    }
                }

                const clocking = {
                    id: Date.now(),
                    userId: user.workerId,
                    userName: user.name,
                    type: type,
                    timestamp: new Date(),
                    worksite: obra.id,
                    worksiteName: obra.nombre_obra,
                    cliente: obra.cliente,
                    location: location,
                    distance: distanceToWorksite,
                    gpsValid: distanceToWorksite ? (distanceToWorksite <= obra.radius) : null,
                    faceRecognized: faceRecognized,
                    faceSimilarity: similarity,
                    photo: photoBase64,  // Foto siempre guardada
                    photoTimestamp: new Date().toISOString()
                };

                onClocking(clocking);

                setSuccessData({
                    type: type,
                    obra: obra.nombre_obra,
                    time: new Date().toLocaleTimeString('es-ES'),
                    similarity: similarity,
                    distance: distanceToWorksite,
                    gpsValid: distanceToWorksite ? (distanceToWorksite <= obra.radius) : null,
                    faceRecognized: faceRecognized
                });

                setStep('success');

                setTimeout(() => {
                    setStep('ready');
                    setSelectedObra('');
                    setSuccessData(null);
                }, 4000);
            };

            if (step === 'first-time') {
                return (
                    <div className="card">
                        <div className="card-header">
                            <h2 className="card-title">TU C√ìDIGO QR PERSONAL</h2>
                        </div>
                        
                        <div className="success-message">
                            Tu QR ha sido generado y guardado en este dispositivo
                        </div>

                        <div className="instruction-box">
                            <h3>Importante:</h3>
                            <ol>
                                <li>Este QR es √öNICO y personal</li>
                                <li>Ya est√° guardado en tu tel√©fono</li>
                                <li>No necesitas escanearlo de nuevo</li>
                                <li>Solo √∫salo para fichar cada d√≠a</li>
                            </ol>
                        </div>

                        <div className="qr-display">
                            <h3 style={{marginBottom: '15px'}}>Tu QR:</h3>
                            <div id="my-qr-code"></div>
                            <p style={{marginTop: '15px', fontSize: '12px', color: '#6b7280'}}>
                                ID: {user.workerId}
                            </p>
                        </div>

                        <button className="btn btn-primary btn-large" onClick={() => setStep('ready')}>
                            Continuar
                        </button>
                    </div>
                );
            }

            if (step === 'ready') {
                // Decidir si este fichaje tendr√° verificaci√≥n aleatoria
                const willRequireFaceRecognition = Math.random() < (FACE_CONFIG.randomPercentage / 100);
                
                return (
                    <div className="card">
                        <div className="card-header">
                            <h2 className="card-title">FICHAJE DIARIO</h2>
                        </div>

                        <div className="worker-info-box">
                            <h3>Trabajador</h3>
                            <p><strong>Nombre:</strong> {user.name}</p>
                            <p><strong>ID:</strong> {user.workerId}</p>
                            <p style={{fontSize: '13px', marginTop: '10px'}}>
                                QR Guardado ‚úì
                            </p>
                        </div>

                        <div className="form-group">
                            <label className="form-label">Obra:</label>
                            <select 
                                className="form-select"
                                value={selectedObra}
                                onChange={(e) => setSelectedObra(e.target.value)}
                            >
                                <option value="">-- Selecciona la obra --</option>
                                {COMPANY_DATA.obras
                                    .filter(obra => obra.lat && obra.lng)  // Solo obras con GPS configurado
                                    .map(obra => (
                                        <option key={obra.id} value={obra.nombre_obra}>
                                            {obra.nombre_obra} - {obra.cliente}
                                        </option>
                                    ))
                                }
                            </select>
                            {COMPANY_DATA.obras.filter(o => o.lat && o.lng).length === 0 && (
                                <p style={{color: '#ef4444', fontSize: '13px', marginTop: '8px'}}>
                                    ‚ö†Ô∏è No hay obras con GPS configurado. Contacta con el administrador.
                                </p>
                            )}
                        </div>

                        {/* SISTEMA DUAL: Fichaje r√°pido (85%) + Verificaci√≥n facial aleatoria (15%) */}
                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: '1fr',
                            gap: '15px',
                            marginTop: '20px'
                        }}>
                            {/* BOT√ìN PRINCIPAL: Fichaje R√°pido */}
                            <div style={{
                                background: '#ffffff',
                                borderRadius: '8px',
                                padding: '20px',
                                border: '2px solid #10b981',
                                boxShadow: '0 2px 8px rgba(16, 185, 129, 0.1)'
                            }}>
                                <div style={{
                                    marginBottom: '15px'
                                }}>
                                    <div style={{
                                        fontSize: '16px',
                                        fontWeight: '700',
                                        color: '#1f2937',
                                        marginBottom: '6px'
                                    }}>
                                        FICHAJE DIARIO
                                    </div>
                                    <div style={{
                                        fontSize: '13px',
                                        color: '#6b7280'
                                    }}>
                                        Sistema autom√°tico inteligente
                                    </div>
                                </div>
                                
                                <ul style={{
                                    listStyle: 'none',
                                    padding: '0',
                                    margin: '0 0 15px 0',
                                    fontSize: '13px',
                                    color: '#374151',
                                    lineHeight: '1.6'
                                }}>
                                    <li>‚Ä¢ 85% fichajes r√°pidos (2-3 segundos)</li>
                                    <li>‚Ä¢ 15% verificaci√≥n facial (8 segundos)</li>
                                    <li>‚Ä¢ Sistema decide autom√°ticamente</li>
                                    <li>‚Ä¢ Foto y GPS en todos los fichajes</li>
                                </ul>
                                
                                <button 
                                    className="btn btn-large" 
                                    style={{
                                        width: '100%',
                                        background: '#10b981',
                                        color: 'white',
                                        fontWeight: '600',
                                        fontSize: '15px',
                                        border: 'none',
                                        padding: '14px'
                                    }}
                                    onClick={() => {
                                        if (!selectedObra) {
                                            return;
                                        }
                                        // üé≤ ALEATORIO: 15% facial, 85% r√°pido
                                        const random = Math.random();
                                        const useFacial = random < 0.15;
                                        console.log(`üé≤ Aleatorio: ${(random*100).toFixed(1)}% ‚Üí ${useFacial ? 'FACIAL' : 'R√ÅPIDO'}`);
                                        
                                        if (useFacial) {
                                            const regs = JSON.parse(localStorage.getItem('face_registrations') || '{}');
                                            if (regs[user.workerId]) {
                                                console.log('üîç Verificaci√≥n facial aleatoria');
                                                startFaceRecognition();
                                            } else {
                                                console.log('‚ö†Ô∏è Sin rostro, fallback a r√°pido');
                                                quickClocking();
                                            }
                                        } else {
                                            quickClocking();
                                        }
                                    }}
                                    disabled={!selectedObra}
                                >
                                    FICHAR AHORA
                                </button>
                                
                                <div style={{
                                    marginTop: '12px',
                                    fontSize: '11px',
                                    color: '#9ca3af',
                                    textAlign: 'center'
                                }}>
                                    Sistema decide autom√°ticamente: 85% r√°pido / 15% facial
                                </div>
                            </div>
                        </div>

                        <div style={{
                            marginTop: '20px',
                            padding: '12px 16px',
                            background: '#eff6ff',
                            borderRadius: '6px',
                            border: '1px solid #bfdbfe',
                            fontSize: '12px',
                            color: '#1e40af',
                            lineHeight: '1.5'
                        }}>
                            <strong style={{color: '#1e3a8a'}}>Sistema anti-fraude:</strong> El sistema decide autom√°ticamente de forma aleatoria: 85% de los fichajes son r√°pidos (2-3s) y 15% incluyen verificaci√≥n facial completa (8s). Esto es impredecible para evitar fraudes.
                        </div>
                    </div>
                );
            }

            if (step === 'camera') {
                return (
                    <div className="card">
                        <div className="card-header">
                            <h2 className="card-title">üì∏ CAPTURANDO FOTO...</h2>
                        </div>

                        <div style={{textAlign: 'center', padding: '40px'}}>
                            <div className="spinner" style={{
                                border: '6px solid #e0e7ff',
                                borderTop: '6px solid #10b981',
                                borderRadius: '50%',
                                width: '80px',
                                height: '80px',
                                animation: 'spin 1s linear infinite',
                                margin: '0 auto 30px'
                            }}></div>
                            
                            <div style={{fontSize: '16px', color: '#059669', marginBottom: '15px'}}>
                                Activando c√°mara...
                            </div>
                            
                            <div style={{fontSize: '14px', color: '#6b7280'}}>
                                <div>‚è±Ô∏è Tiempo estimado: 1-2 segundos</div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (step === 'validating') {
                return (
                    <div className="card">
                        <div className="card-header">
                            <h2 className="card-title">üìç VALIDANDO UBICACI√ìN...</h2>
                        </div>

                        <div style={{textAlign: 'center', padding: '40px'}}>
                            <div className="spinner" style={{
                                border: '6px solid #e0e7ff',
                                borderTop: '6px solid #10b981',
                                borderRadius: '50%',
                                width: '80px',
                                height: '80px',
                                animation: 'spin 1s linear infinite',
                                margin: '0 auto 30px'
                            }}></div>
                            
                            <div style={{fontSize: '16px', color: '#059669', marginBottom: '15px'}}>
                                Obteniendo ubicaci√≥n GPS...
                            </div>
                            
                            <div style={{fontSize: '14px', color: '#6b7280'}}>
                                <div>üì∏ Foto capturada ‚úì</div>
                                <div style={{marginTop: '8px'}}>‚è±Ô∏è Finalizando...</div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (step === 'processing') {
                return (
                    <div className="card">
                        <div className="card-header">
                            <h2 className="card-title">üîç VERIFICACI√ìN FACIAL...</h2>
                        </div>

                        <div style={{textAlign: 'center', padding: '40px'}}>
                            <div className="spinner" style={{
                                border: '6px solid #e0e7ff',
                                borderTop: '6px solid #2563eb',
                                borderRadius: '50%',
                                width: '80px',
                                height: '80px',
                                animation: 'spin 1s linear infinite',
                                margin: '0 auto 30px'
                            }}></div>
                            
                            <div style={{fontSize: '16px', color: '#2563eb', marginBottom: '15px'}}>
                                Reconociendo rostro y validando ubicaci√≥n...
                            </div>
                            
                            <div style={{fontSize: '14px', color: '#6b7280'}}>
                                <div>‚è±Ô∏è Tiempo estimado: 5-10 segundos</div>
                                <div style={{marginTop: '8px'}}>üîí Verificaci√≥n de seguridad en progreso</div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (step === 'success') {
                const isFaceVerified = successData.faceRecognized;
                
                return (
                    <div className="card">
                        <div className="success-message" style={{padding: '40px', fontSize: '18px'}}>
                            <h2 style={{fontSize: '32px', marginBottom: '20px'}}>
                                {successData.type === 'in' ? '‚úì ENTRADA REGISTRADA' : '‚úì SALIDA REGISTRADA'}
                            </h2>
                            <p><strong>Obra:</strong> {successData.obra}</p>
                            <p><strong>Hora:</strong> {successData.time}</p>
                            
                            {isFaceVerified ? (
                                <p style={{marginTop: '20px', fontSize: '14px', color: '#2563eb'}}>
                                    üîç Rostro reconocido ‚úì ({(successData.similarity * 100).toFixed(1)}% similitud)
                                </p>
                            ) : (
                                <p style={{marginTop: '20px', fontSize: '14px', color: '#059669'}}>
                                    üì∏ Foto capturada ‚úì (Fichaje r√°pido)
                                </p>
                            )}
                            
                            {successData.distance !== null && (
                                <p style={{fontSize: '14px', marginTop: '5px'}}>
                                    üìç Ubicaci√≥n: {successData.gpsValid ? '‚úÖ' : '‚ö†Ô∏è'} 
                                    {' '}({successData.distance.toFixed(0)}m de la obra)
                                </p>
                            )}
                        </div>
                    </div>
                );
            }

            return null;
        };

        // Panel Admin - C√≥digos QR de Trabajadores
        const AdminQRPanel = () => {
            const [searchTerm, setSearchTerm] = useState('');

            useEffect(() => {
                // Generar QR para cada trabajador
                const savedUsers = localStorage.getItem('app_users');
                const workers = savedUsers ? JSON.parse(savedUsers) : COMPANY_DATA.trabajadores;
                
                workers.forEach(worker => {
                    const elementId = `qr-worker-${worker.id}`;
                    const element = document.getElementById(elementId);
                    if (element && element.innerHTML === '') {
                        new QRCode(element, {
                            text: `WORKER-${worker.id}`,
                            width: 180,
                            height: 180
                        });
                    }
                });
            }, []);

            const printSingleQR = (workerId, workerName) => {
                const printWindow = window.open('', '_blank');
                const qrElement = document.getElementById(`qr-worker-${workerId}`);
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>QR - ${workerName}</title>
                        <style>
                            @media print {
                                @page { 
                                    size: 85mm 54mm;
                                    margin: 0;
                                }
                                body {
                                    margin: 0;
                                    padding: 0;
                                    width: 85mm;
                                    height: 54mm;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                }
                            }
                            body {
                                font-family: Arial, sans-serif;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                justify-content: center;
                                padding: 8mm;
                                text-align: center;
                            }
                            .qr-container {
                                border: 2px solid #2563eb;
                                border-radius: 10px;
                                padding: 10px;
                                background: white;
                            }
                            .worker-name {
                                font-size: 11px;
                                font-weight: bold;
                                margin-bottom: 8px;
                                color: #1f2937;
                                text-transform: uppercase;
                            }
                            .worker-id {
                                font-size: 9px;
                                color: #6b7280;
                                margin-bottom: 10px;
                            }
                            .qr-code {
                                margin: 0 auto;
                            }
                            .footer {
                                font-size: 8px;
                                color: #ef4444;
                                font-weight: bold;
                                margin-top: 8px;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="qr-container">
                            <div class="worker-name">${workerName}</div>
                            <div class="worker-id">ID: ${workerId}</div>
                            <div class="qr-code">${qrElement.innerHTML}</div>
                            <div class="footer">C√ìDIGO PERSONAL</div>
                        </div>
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 250);
            };

            const savedUsers = localStorage.getItem('app_users');
            const workers = savedUsers ? JSON.parse(savedUsers) : COMPANY_DATA.trabajadores;

            const filteredWorkers = workers.filter(worker =>
                worker.nombre.toLowerCase().includes(searchTerm.toLowerCase()) ||
                worker.id.toString().includes(searchTerm)
            );

            return (
                <div className="card">
                    <div className="card-header">
                        <h2 className="card-title">C√≥digos QR de Trabajadores</h2>
                    </div>
                    
                    <div style={{padding: '20px', background: '#f9fafb', borderRadius: '8px', marginBottom: '20px'}}>
                        <p style={{marginBottom: '15px', color: '#374151', fontSize: '14px'}}>
                            Cada trabajador tiene un c√≥digo QR √∫nico para fichar. Puedes imprimir individualmente en formato carnet (85x54mm).
                        </p>
                        
                        <input
                            type="text"
                            placeholder="Buscar por nombre o ID..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            style={{
                                width: '100%',
                                padding: '10px',
                                border: '1px solid #d1d5db',
                                borderRadius: '6px',
                                fontSize: '14px'
                            }}
                        />
                        <div style={{marginTop: '8px', fontSize: '13px', color: '#6b7280'}}>
                            {filteredWorkers.length} de {workers.length} trabajadores
                        </div>
                    </div>

                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))',
                        gap: '20px',
                        padding: '0'
                    }}>
                        {filteredWorkers.map(worker => (
                            <div key={worker.id} style={{
                                border: '2px solid #e5e7eb',
                                borderRadius: '12px',
                                padding: '20px',
                                background: 'white',
                                textAlign: 'center',
                                transition: 'all 0.3s',
                                ':hover': {
                                    boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
                                }
                            }}>
                                <div style={{
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    color: '#1f2937',
                                    marginBottom: '4px',
                                    minHeight: '40px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center'
                                }}>
                                    {worker.nombre}
                                </div>
                                <div style={{
                                    fontSize: '12px',
                                    color: '#6b7280',
                                    marginBottom: '15px'
                                }}>
                                    ID: {worker.id}
                                </div>
                                <div 
                                    id={`qr-worker-${worker.id}`}
                                    style={{
                                        display: 'flex',
                                        justifyContent: 'center',
                                        marginBottom: '15px'
                                    }}
                                ></div>
                                <div style={{
                                    fontSize: '10px',
                                    color: '#ef4444',
                                    fontWeight: '600',
                                    marginBottom: '15px',
                                    letterSpacing: '0.5px'
                                }}>
                                    C√ìDIGO PERSONAL
                                </div>
                                <button
                                    onClick={() => printSingleQR(worker.id, worker.nombre)}
                                    className="btn btn-primary"
                                    style={{
                                        width: '100%',
                                        padding: '10px',
                                        fontSize: '13px'
                                    }}
                                >
                                    Imprimir QR
                                </button>
                            </div>
                        ))}
                    </div>

                    {filteredWorkers.length === 0 && (
                        <div style={{
                            textAlign: 'center',
                            padding: '40px',
                            color: '#6b7280'
                        }}>
                            No se encontraron trabajadores con ese criterio
                        </div>
                    )}
                </div>
            );
        };

        // Panel Admin - Estad√≠sticas
        const AdminStats = ({ clockings, workers, absences }) => {
            const [selectedObra, setSelectedObra] = useState('all');
            const [currentTime, setCurrentTime] = useState(new Date());

            // Actualizar tiempo cada minuto
            useEffect(() => {
                const interval = setInterval(() => {
                    setCurrentTime(new Date());
                }, 60000);
                return () => clearInterval(interval);
            }, []);

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Obtener obras con fichajes hoy
            const obrasHoy = [...new Set(clockings
                .filter(c => new Date(c.timestamp) >= today)
                .map(c => c.worksite)
                .filter(Boolean)
            )];

            // Filtrar fichajes de hoy
            let todayClockings = clockings.filter(c => new Date(c.timestamp) >= today);

            // Aplicar filtro por obra
            if (selectedObra !== 'all') {
                todayClockings = todayClockings.filter(c => c.worksite === selectedObra);
            }

            const todayEntries = todayClockings.filter(c => c.type === 'in').length;
            const todayExits = todayClockings.filter(c => c.type === 'out').length;

            // Trabajadores actualmente en obra (usando workers din√°micos)
            const workersInSite = [];
            workers.forEach(worker => {
                const userClockings = clockings.filter(c => 
                    String(c.userId) === String(worker.id) && 
                    new Date(c.timestamp) >= today &&
                    (selectedObra === 'all' || c.worksite === selectedObra)
                );
                if (userClockings.length > 0) {
                    const lastClocking = userClockings[userClockings.length - 1];
                    if (lastClocking.type === 'in') {
                        workersInSite.push({
                            ...worker,
                            obra: lastClocking.worksiteName,
                            cliente: lastClocking.cliente,
                            entryTime: lastClocking.timestamp
                        });
                    }
                }
            });

            // Estad√≠sticas por obra (solo hoy)
            const obraStats = {};
            todayClockings.forEach(c => {
                if (c.worksite) {
                    if (!obraStats[c.worksite]) {
                        obraStats[c.worksite] = {
                            nombre: c.worksiteName,
                            cliente: c.cliente,
                            entradas: 0,
                            salidas: 0,
                            trabajadoresActivos: 0
                        };
                    }
                    if (c.type === 'in') obraStats[c.worksite].entradas++;
                    if (c.type === 'out') obraStats[c.worksite].salidas++;
                }
            });

            // Contar trabajadores activos por obra
            workersInSite.forEach(w => {
                const obraId = clockings.find(c => 
                    c.userId === w.id && 
                    c.worksiteName === w.obra &&
                    new Date(c.timestamp) >= today
                )?.worksite;
                if (obraId && obraStats[obraId]) {
                    obraStats[obraId].trabajadoresActivos++;
                }
            });

            return (
                <div>
                    {/* Selector de Obra */}
                    <div className="card" style={{marginBottom: '20px'}}>
                        <div style={{padding: '20px'}}>
                            <label style={{
                                display: 'block',
                                fontSize: '14px',
                                fontWeight: '600',
                                marginBottom: '10px',
                                color: '#374151'
                            }}>
                                Filtrar por Obra:
                            </label>
                            <select
                                value={selectedObra}
                                onChange={(e) => setSelectedObra(e.target.value)}
                                className="form-select"
                                style={{
                                    maxWidth: '500px',
                                    fontSize: '14px',
                                    padding: '12px'
                                }}
                            >
                                <option value="all">Todas las obras</option>
                                {obrasHoy.map(obraId => {
                                    const obra = clockings.find(c => c.worksite === obraId);
                                    return (
                                        <option key={obraId} value={obraId}>
                                            {obra?.worksiteName} - {obra?.cliente}
                                        </option>
                                    );
                                })}
                            </select>
                            <div style={{fontSize: '13px', color: '#6b7280', marginTop: '8px'}}>
                                {selectedObra === 'all' 
                                    ? `Mostrando todas las obras (${obrasHoy.length} activa${obrasHoy.length !== 1 ? 's' : ''} hoy)`
                                    : `Mostrando solo: ${clockings.find(c => c.worksite === selectedObra)?.worksiteName}`
                                }
                            </div>
                        </div>
                    </div>

                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-value">{todayClockings.length}</div>
                            <div className="stat-label">Fichajes Hoy</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">{todayEntries}</div>
                            <div className="stat-label">Entradas Hoy</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">{todayExits}</div>
                            <div className="stat-label">Salidas Hoy</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">{workersInSite.length}</div>
                            <div className="stat-label">Trabajando Ahora</div>
                        </div>
                    </div>

                    {workersInSite.length > 0 && (
                        <div className="card">
                            <div className="card-header">
                                <h2 className="card-title">
                                    Actualmente Trabajando ({workersInSite.length})
                                </h2>
                                <div style={{fontSize: '13px', color: '#6b7280'}}>
                                    Actualizado: {currentTime.toLocaleTimeString('es-ES')}
                                </div>
                            </div>
                            <div className="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Trabajador</th>
                                            <th>Obra</th>
                                            <th>Cliente</th>
                                            <th>Hora Entrada</th>
                                            <th>Tiempo Trabajado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {workersInSite.map(worker => {
                                            const entryTime = new Date(worker.entryTime);
                                            const diff = currentTime - entryTime;
                                            const hours = Math.floor(diff / 3600000);
                                            const minutes = Math.floor((diff % 3600000) / 60000);
                                            
                                            return (
                                                <tr key={worker.id}>
                                                    <td>{worker.id}</td>
                                                    <td style={{fontWeight: '500'}}>{worker.nombre}</td>
                                                    <td>{worker.obra}</td>
                                                    <td style={{fontSize: '13px', color: '#6b7280'}}>
                                                        {worker.cliente}
                                                    </td>
                                                    <td>{entryTime.toLocaleTimeString('es-ES')}</td>
                                                    <td>
                                                        <span className="status-badge status-working">
                                                            {hours}h {minutes}m
                                                        </span>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {selectedObra === 'all' && Object.keys(obraStats).length > 0 && (
                        <div className="card">
                            <div className="card-header">
                                <h2 className="card-title">Resumen por Obra (Hoy)</h2>
                            </div>
                            <div className="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Obra</th>
                                            <th>Cliente</th>
                                            <th>Entradas</th>
                                            <th>Salidas</th>
                                            <th>Trabajando Ahora</th>
                                            <th>Total Fichajes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {Object.entries(obraStats)
                                            .sort((a, b) => b[1].trabajadoresActivos - a[1].trabajadoresActivos)
                                            .map(([id, obra]) => (
                                                <tr key={id}>
                                                    <td style={{fontWeight: '500'}}>{obra.nombre}</td>
                                                    <td>{obra.cliente}</td>
                                                    <td>
                                                        <span className="status-badge status-in">
                                                            {obra.entradas}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span className="status-badge status-out">
                                                            {obra.salidas}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span className="status-badge status-working">
                                                            {obra.trabajadoresActivos}
                                                        </span>
                                                    </td>
                                                    <td>{obra.entradas + obra.salidas}</td>
                                                </tr>
                                            ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {workersInSite.length === 0 && (
                        <div className="card">
                            <div style={{
                                textAlign: 'center',
                                padding: '40px',
                                color: '#6b7280'
                            }}>
                                No hay trabajadores actualmente trabajando
                                {selectedObra !== 'all' && ' en la obra seleccionada'}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ========================
        // SISTEMA DE TRADUCCIONES
        // ========================
        
        const TRANSLATIONS = {
            es: {
                // Login
                login_title: 'Sistema de Control de Presencia',
                login_user: 'Usuario',
                login_password: 'Contrase√±a',
                login_button: 'Iniciar Sesi√≥n',
                login_error: 'Usuario o contrase√±a incorrectos',
                
                // Navegaci√≥n
                nav_clock: 'Fichar',
                nav_history: 'Historial',
                nav_monitor: 'Monitor',
                nav_stats: 'Estad√≠sticas',
                nav_absences: 'Ausencias',
                nav_users: 'Usuarios',
                nav_gps: 'GPS',
                nav_qr: 'QR Codes',
                nav_face: 'Registro Facial',
                nav_audit: 'Auditor√≠a',
                nav_logout: 'Cerrar Sesi√≥n',
                
                // Fichaje
                clock_title: 'Fichaje Diario',
                clock_subtitle: 'Sistema autom√°tico inteligente',
                clock_worker: 'Trabajador',
                clock_worksite: 'Obra',
                clock_select_worksite: '-- Selecciona la obra --',
                clock_button: 'FICHAR AHORA',
                clock_rapid: '85% fichajes r√°pidos (2-3 segundos)',
                clock_facial: '15% verificaci√≥n facial (8 segundos)',
                clock_auto: 'Sistema decide autom√°ticamente',
                clock_photo_gps: 'Foto y GPS en todos los fichajes',
                clock_system_info: 'Sistema decide autom√°ticamente: 85% r√°pido / 15% facial',
                clock_antifraud: 'Sistema anti-fraude: El sistema decide autom√°ticamente de forma aleatoria: 85% de los fichajes son r√°pidos (2-3s) y 15% incluyen verificaci√≥n facial completa (8s). Esto es impredecible para evitar fraudes.',
                
                // Estados fichaje
                clock_capturing: 'Capturando foto...',
                clock_validating: 'Validando GPS...',
                clock_processing: 'Reconociendo rostro...',
                clock_success: 'REGISTRADO CORRECTAMENTE',
                clock_entry: 'ENTRADA',
                clock_exit: 'SALIDA',
                clock_registered: 'registrada en',
                clock_face_recognized: 'Rostro reconocido',
                clock_similarity: 'Similitud',
                clock_new_clock: 'Nuevo fichaje',
                
                // Historial
                history_title: 'Historial de Fichajes',
                history_export: 'Exportar Excel',
                history_filters: 'Filtros de B√∫squeda',
                history_clear: 'Limpiar Filtros',
                history_worker: 'Trabajador',
                history_all_workers: 'Todos',
                history_worksite: 'Obra',
                history_all_worksites: 'Todas',
                history_type: 'Tipo',
                history_all_types: 'Todos',
                history_entry: 'Entrada',
                history_exit: 'Salida',
                history_from: 'Desde',
                history_to: 'Hasta',
                history_results: 'Resultados',
                history_of: 'de',
                history_clockings: 'fichajes',
                history_filtered: '(filtrado aplicado)',
                history_no_results: 'No hay fichajes que coincidan con los filtros',
                history_date_time: 'Fecha/Hora',
                history_gps: 'GPS',
                history_face: 'Rostro',
                history_no_gps: 'Sin GPS',
                
                // Monitor
                monitor_title: 'Monitor en Tiempo Real',
                monitor_active: 'Trabajadores Activos',
                monitor_today: 'Fichajes Hoy',
                monitor_worksites: 'Obras Activas',
                monitor_absences: 'Ausencias Hoy',
                
                // Estad√≠sticas
                stats_title: 'Estad√≠sticas',
                stats_total_clockings: 'Total Fichajes',
                stats_avg_hours: 'Promedio Horas/D√≠a',
                stats_absences: 'Ausencias',
                stats_workers: 'Trabajadores',
                
                // GPS
                gps_title: 'Configuraci√≥n GPS',
                gps_enable: 'Activar validaci√≥n GPS',
                gps_mode: 'Modo de validaci√≥n',
                gps_mode_alert: 'Alerta (permite fichar con advertencia)',
                gps_mode_block: 'Bloquear (impide fichar si fuera de rango)',
                gps_radius: 'Radio de validaci√≥n (metros)',
                gps_save: 'Guardar Configuraci√≥n',
                gps_status: 'Estado GPS',
                gps_active: 'ACTIVO',
                gps_inactive: 'DESACTIVADO',
                gps_warning: 'La validaci√≥n GPS est√° desactivada. Los fichajes no verificar√°n la ubicaci√≥n.',
                
                // Usuarios
                users_title: 'Gesti√≥n de Usuarios',
                users_add: 'Agregar Usuario',
                users_name: 'Nombre',
                users_username: 'Usuario',
                users_role: 'Rol',
                users_password: 'Contrase√±a',
                users_worksite: 'Obra Asignada',
                users_save: 'Guardar',
                users_cancel: 'Cancelar',
                users_edit: 'Editar',
                users_delete: 'Eliminar',
                
                // Com√∫n
                common_yes: 'S√≠',
                common_no: 'No',
                common_save: 'Guardar',
                common_cancel: 'Cancelar',
                common_close: 'Cerrar',
                common_loading: 'Cargando...',
                common_error: 'Error',
                common_success: '√âxito',
            },
            pt: {
                // Login
                login_title: 'Sistema de Controlo de Presen√ßa',
                login_user: 'Utilizador',
                login_password: 'Palavra-passe',
                login_button: 'Iniciar Sess√£o',
                login_error: 'Utilizador ou palavra-passe incorretos',
                
                // Navega√ß√£o
                nav_clock: 'Marcar Ponto',
                nav_history: 'Hist√≥rico',
                nav_monitor: 'Monitor',
                nav_stats: 'Estat√≠sticas',
                nav_absences: 'Aus√™ncias',
                nav_users: 'Utilizadores',
                nav_gps: 'GPS',
                nav_qr: 'C√≥digos QR',
                nav_face: 'Registo Facial',
                nav_audit: 'Auditoria',
                nav_logout: 'Terminar Sess√£o',
                
                // Marca√ß√£o de ponto
                clock_title: 'Marca√ß√£o de Ponto Di√°ria',
                clock_subtitle: 'Sistema autom√°tico inteligente',
                clock_worker: 'Trabalhador',
                clock_worksite: 'Obra',
                clock_select_worksite: '-- Selecione a obra --',
                clock_button: 'MARCAR PONTO AGORA',
                clock_rapid: '85% marca√ß√µes r√°pidas (2-3 segundos)',
                clock_facial: '15% verifica√ß√£o facial (8 segundos)',
                clock_auto: 'Sistema decide automaticamente',
                clock_photo_gps: 'Foto e GPS em todas as marca√ß√µes',
                clock_system_info: 'Sistema decide automaticamente: 85% r√°pido / 15% facial',
                clock_antifraud: 'Sistema anti-fraude: O sistema decide automaticamente de forma aleat√≥ria: 85% das marca√ß√µes s√£o r√°pidas (2-3s) e 15% incluem verifica√ß√£o facial completa (8s). Isto √© imprevis√≠vel para evitar fraudes.',
                
                // Estados marca√ß√£o
                clock_capturing: 'A capturar foto...',
                clock_validating: 'A validar GPS...',
                clock_processing: 'A reconhecer rosto...',
                clock_success: 'REGISTADO CORRETAMENTE',
                clock_entry: 'ENTRADA',
                clock_exit: 'SA√çDA',
                clock_registered: 'registada em',
                clock_face_recognized: 'Rosto reconhecido',
                clock_similarity: 'Similaridade',
                clock_new_clock: 'Nova marca√ß√£o',
                
                // Hist√≥rico
                history_title: 'Hist√≥rico de Marca√ß√µes',
                history_export: 'Exportar Excel',
                history_filters: 'Filtros de Pesquisa',
                history_clear: 'Limpar Filtros',
                history_worker: 'Trabalhador',
                history_all_workers: 'Todos',
                history_worksite: 'Obra',
                history_all_worksites: 'Todas',
                history_type: 'Tipo',
                history_all_types: 'Todos',
                history_entry: 'Entrada',
                history_exit: 'Sa√≠da',
                history_from: 'De',
                history_to: 'At√©',
                history_results: 'Resultados',
                history_of: 'de',
                history_clockings: 'marca√ß√µes',
                history_filtered: '(filtro aplicado)',
                history_no_results: 'N√£o h√° marca√ß√µes que correspondam aos filtros',
                history_date_time: 'Data/Hora',
                history_gps: 'GPS',
                history_face: 'Rosto',
                history_no_gps: 'Sem GPS',
                
                // Monitor
                monitor_title: 'Monitor em Tempo Real',
                monitor_active: 'Trabalhadores Ativos',
                monitor_today: 'Marca√ß√µes Hoje',
                monitor_worksites: 'Obras Ativas',
                monitor_absences: 'Aus√™ncias Hoje',
                
                // Estat√≠sticas
                stats_title: 'Estat√≠sticas',
                stats_total_clockings: 'Total Marca√ß√µes',
                stats_avg_hours: 'M√©dia Horas/Dia',
                stats_absences: 'Aus√™ncias',
                stats_workers: 'Trabalhadores',
                
                // GPS
                gps_title: 'Configura√ß√£o GPS',
                gps_enable: 'Ativar valida√ß√£o GPS',
                gps_mode: 'Modo de valida√ß√£o',
                gps_mode_alert: 'Alerta (permite marcar com aviso)',
                gps_mode_block: 'Bloquear (impede marcar se fora do alcance)',
                gps_radius: 'Raio de valida√ß√£o (metros)',
                gps_save: 'Guardar Configura√ß√£o',
                gps_status: 'Estado GPS',
                gps_active: 'ATIVO',
                gps_inactive: 'DESATIVADO',
                gps_warning: 'A valida√ß√£o GPS est√° desativada. As marca√ß√µes n√£o verificar√£o a localiza√ß√£o.',
                
                // Utilizadores
                users_title: 'Gest√£o de Utilizadores',
                users_add: 'Adicionar Utilizador',
                users_name: 'Nome',
                users_username: 'Utilizador',
                users_role: 'Fun√ß√£o',
                users_password: 'Palavra-passe',
                users_worksite: 'Obra Atribu√≠da',
                users_save: 'Guardar',
                users_cancel: 'Cancelar',
                users_edit: 'Editar',
                users_delete: 'Eliminar',
                
                // Comum
                common_yes: 'Sim',
                common_no: 'N√£o',
                common_save: 'Guardar',
                common_cancel: 'Cancelar',
                common_close: 'Fechar',
                common_loading: 'A carregar...',
                common_error: 'Erro',
                common_success: 'Sucesso',
            }
        };

        // Hook para traducciones
        const useTranslation = () => {
            const [language, setLanguage] = React.useState(() => {
                return localStorage.getItem('app_language') || 'es';
            });

            const t = (key) => {
                return TRANSLATIONS[language][key] || key;
            };

            const changeLanguage = (lang) => {
                setLanguage(lang);
                localStorage.setItem('app_language', lang);
            };

            return { t, language, changeLanguage };
        };

        // Panel Admin - Historial
        const AdminHistory = ({ clockings }) => {
            // Filtros usando estado local sin hooks problem√°ticos
            const [filters, setFilters] = React.useState({
                trabajador: '',
                obra: '',
                tipo: '',
                fechaDesde: '',
                fechaHasta: ''
            });

            // Listas √∫nicas para selectores
            const uniqueWorkers = React.useMemo(() => 
                [...new Set(clockings.map(c => c.userName))].sort(), 
                [clockings]
            );
            const uniqueWorksites = React.useMemo(() => 
                [...new Set(clockings.map(c => c.worksiteName))].sort(), 
                [clockings]
            );

            // Filtrar clockings
            const filteredClockings = React.useMemo(() => {
                let filtered = [...clockings];

                if (filters.trabajador) {
                    filtered = filtered.filter(c => c.userName === filters.trabajador);
                }
                if (filters.obra) {
                    filtered = filtered.filter(c => c.worksiteName === filters.obra);
                }
                if (filters.tipo) {
                    filtered = filtered.filter(c => c.type === filters.tipo);
                }
                if (filters.fechaDesde) {
                    const desde = new Date(filters.fechaDesde);
                    desde.setHours(0, 0, 0, 0);
                    filtered = filtered.filter(c => new Date(c.timestamp) >= desde);
                }
                if (filters.fechaHasta) {
                    const hasta = new Date(filters.fechaHasta);
                    hasta.setHours(23, 59, 59, 999);
                    filtered = filtered.filter(c => new Date(c.timestamp) <= hasta);
                }

                return filtered;
            }, [clockings, filters]);

            const exportToExcel = () => {
                const excelData = filteredClockings.map(c => ({
                    'ID Trabajador': c.userId,
                    'Nombre': c.userName,
                    'Tipo': c.type === 'in' ? 'Entrada' : 'Salida',
                    'Fecha': new Date(c.timestamp).toLocaleDateString('es-ES'),
                    'Hora': new Date(c.timestamp).toLocaleTimeString('es-ES'),
                    'Obra': c.worksiteName,
                    'Cliente': c.cliente,
                    'Latitud': (c.location && c.location.lat) ? c.location.lat : 'Sin GPS',
                    'Longitud': (c.location && c.location.lng) ? c.location.lng : 'Sin GPS',
                    'Rostro Reconocido': c.faceRecognized ? 'S√≠' : 'No',
                    'Similitud Facial': c.faceSimilarity ? `${(c.faceSimilarity * 100).toFixed(1)}%` : ''
                }));

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                const colWidths = [
                    { wch: 15 }, { wch: 35 }, { wch: 10 }, { wch: 12 }, { wch: 10 },
                    { wch: 30 }, { wch: 25 }, { wch: 12 }, { wch: 12 }, { wch: 18 }, { wch: 15 }
                ];
                ws['!cols'] = colWidths;
                
                XLSX.utils.book_append_sheet(wb, ws, 'Fichajes');
                XLSX.writeFile(wb, `Fichajes_${new Date().toISOString().split('T')[0]}.xlsx`);
            };

            return (
                <div className="card">
                    <div className="card-header">
                        <h2 className="card-title">Historial de Fichajes</h2>
                        <button className="btn btn-success" onClick={exportToExcel}>
                            Exportar Excel ({filteredClockings.length})
                        </button>
                    </div>

                    {/* FILTROS */}
                    <div style={{background: '#f9fafb', padding: '20px', borderRadius: '8px', marginBottom: '20px'}}>
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px'}}>
                            <h3 style={{margin: 0, fontSize: '16px', fontWeight: '600'}}>Filtros de B√∫squeda</h3>
                            <button 
                                className="btn"
                                onClick={() => setFilters({trabajador: '', obra: '', tipo: '', fechaDesde: '', fechaHasta: ''})}
                                style={{background: '#6b7280', color: 'white', padding: '8px 16px', fontSize: '13px'}}
                            >
                                Limpiar Filtros
                            </button>
                        </div>

                        <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '15px'}}>
                            {/* Trabajador */}
                            <div>
                                <label style={{display: 'block', fontSize: '13px', fontWeight: '600', marginBottom: '6px', color: '#374151'}}>
                                    Trabajador
                                </label>
                                <select
                                    className="form-select"
                                    value={filters.trabajador}
                                    onChange={(e) => setFilters({...filters, trabajador: e.target.value})}
                                    style={{width: '100%'}}
                                >
                                    <option value="">Todos</option>
                                    {uniqueWorkers.map(w => <option key={w} value={w}>{w}</option>)}
                                </select>
                            </div>

                            {/* Obra */}
                            <div>
                                <label style={{display: 'block', fontSize: '13px', fontWeight: '600', marginBottom: '6px', color: '#374151'}}>
                                    Obra
                                </label>
                                <select
                                    className="form-select"
                                    value={filters.obra}
                                    onChange={(e) => setFilters({...filters, obra: e.target.value})}
                                    style={{width: '100%'}}
                                >
                                    <option value="">Todas</option>
                                    {uniqueWorksites.map(w => <option key={w} value={w}>{w}</option>)}
                                </select>
                            </div>

                            {/* Tipo */}
                            <div>
                                <label style={{display: 'block', fontSize: '13px', fontWeight: '600', marginBottom: '6px', color: '#374151'}}>
                                    Tipo
                                </label>
                                <select
                                    className="form-select"
                                    value={filters.tipo}
                                    onChange={(e) => setFilters({...filters, tipo: e.target.value})}
                                    style={{width: '100%'}}
                                >
                                    <option value="">Todos</option>
                                    <option value="in">Entrada</option>
                                    <option value="out">Salida</option>
                                </select>
                            </div>

                            {/* Fecha Desde */}
                            <div>
                                <label style={{display: 'block', fontSize: '13px', fontWeight: '600', marginBottom: '6px', color: '#374151'}}>
                                    Desde
                                </label>
                                <input
                                    type="date"
                                    className="form-select"
                                    value={filters.fechaDesde || ''}
                                    onChange={(e) => setFilters({...filters, fechaDesde: e.target.value})}
                                    style={{width: '100%'}}
                                />
                            </div>

                            {/* Fecha Hasta */}
                            <div>
                                <label style={{display: 'block', fontSize: '13px', fontWeight: '600', marginBottom: '6px', color: '#374151'}}>
                                    Hasta
                                </label>
                                <input
                                    type="date"
                                    className="form-select"
                                    value={filters.fechaHasta || ''}
                                    onChange={(e) => setFilters({...filters, fechaHasta: e.target.value})}
                                    style={{width: '100%'}}
                                />
                            </div>
                        </div>

                        {/* Resumen */}
                        <div style={{marginTop: '15px', padding: '12px', background: 'white', borderRadius: '6px', fontSize: '14px', color: '#374151'}}>
                            <strong>Resultados:</strong> {filteredClockings.length} de {clockings.length} fichajes
                            {filteredClockings.length !== clockings.length && (
                                <span style={{marginLeft: '10px', color: '#2563eb'}}>(filtrado aplicado)</span>
                            )}
                        </div>
                    </div>

                    <div className="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Trabajador</th>
                                    <th>Tipo</th>
                                    <th>Fecha/Hora</th>
                                    <th>Obra</th>
                                    <th>GPS</th>
                                    <th>Rostro</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredClockings.length === 0 ? (
                                    <tr>
                                        <td colSpan="6" style={{textAlign: 'center', padding: '40px', color: '#6b7280'}}>
                                            No hay fichajes que coincidan con los filtros
                                        </td>
                                    </tr>
                                ) : (
                                    filteredClockings.slice().reverse().map(c => (
                                        <tr key={c.id}>
                                            <td>{c.userName}</td>
                                            <td>
                                                <span className={`status-badge ${c.type === 'in' ? 'status-active' : 'status-inactive'}`}>
                                                    {c.type === 'in' ? 'ENTRADA' : 'SALIDA'}
                                                </span>
                                            </td>
                                            <td>{new Date(c.timestamp).toLocaleString('es-ES')}</td>
                                            <td>{c.worksiteName}</td>
                                            <td style={{fontSize: '11px'}}>
                                                {c.location && c.location.lat && c.location.lng 
                                                    ? `${c.location.lat.toFixed(4)}, ${c.location.lng.toFixed(4)}` 
                                                    : 'Sin GPS'}
                                            </td>
                                            <td>
                                                {c.faceRecognized ? (
                                                    <span className="status-badge status-active">‚úì</span>
                                                ) : (
                                                    <span className="status-badge status-inactive">‚úï</span>
                                                )}
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // Componente de Auditor√≠a - Solo Gerencia
        const AuditLog = ({ currentUser }) => {
            const [auditLogs, setAuditLogs] = useState([]);
            const [filteredLogs, setFilteredLogs] = useState([]);
            const [filterDate, setFilterDate] = useState('');
            const [filterUser, setFilterUser] = useState('');
            const [filterAction, setFilterAction] = useState('');

            useEffect(() => {
                const savedAudit = localStorage.getItem('audit_log') || '[]';
                const logs = JSON.parse(savedAudit);
                setAuditLogs(logs);
                setFilteredLogs(logs);
            }, []);

            useEffect(() => {
                let filtered = [...auditLogs];

                if (filterDate) {
                    filtered = filtered.filter(log => {
                        const logDate = new Date(log.timestamp).toLocaleDateString('es-ES');
                        return logDate === new Date(filterDate).toLocaleDateString('es-ES');
                    });
                }

                if (filterUser) {
                    filtered = filtered.filter(log => 
                        log.usuario.toLowerCase().includes(filterUser.toLowerCase()) ||
                        log.nombre.toLowerCase().includes(filterUser.toLowerCase())
                    );
                }

                if (filterAction) {
                    filtered = filtered.filter(log => log.accion === filterAction);
                }

                setFilteredLogs(filtered);
            }, [filterDate, filterUser, filterAction, auditLogs]);

            const exportAudit = () => {
                const excelData = filteredLogs.map(log => ({
                    'Fecha': new Date(log.timestamp).toLocaleDateString('es-ES'),
                    'Hora': new Date(log.timestamp).toLocaleTimeString('es-ES'),
                    'Usuario': log.usuario,
                    'Nombre': log.nombre,
                    'Acci√≥n': log.accion,
                    'Detalles': log.detalles
                }));

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // Ajustar ancho de columnas
                const colWidths = [
                    { wch: 12 },  // Fecha
                    { wch: 10 },  // Hora
                    { wch: 20 },  // Usuario
                    { wch: 35 },  // Nombre
                    { wch: 20 },  // Acci√≥n
                    { wch: 50 }   // Detalles
                ];
                ws['!cols'] = colWidths;
                
                XLSX.utils.book_append_sheet(wb, ws, 'Auditor√≠a');
                
                const fileName = `Auditoria_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
            };

            const clearOldLogs = () => {
                if (confirm('¬øDesea eliminar registros de auditor√≠a de m√°s de 90 d√≠as?')) {
                    const ninetyDaysAgo = new Date();
                    ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
                    
                    const filtered = auditLogs.filter(log => 
                        new Date(log.timestamp) > ninetyDaysAgo
                    );
                    
                    localStorage.setItem('audit_log', JSON.stringify(filtered));
                    setAuditLogs(filtered);
                    alert(`Se eliminaron ${auditLogs.length - filtered.length} registros antiguos`);
                }
            };

            const actionTypes = [...new Set(auditLogs.map(log => log.accion))];

            return (
                <div className="card">
                    <div className="card-header">
                        <h2 className="card-title">REGISTRO DE ACCESO AL SISTEMA</h2>
                        <div style={{display: 'flex', gap: '10px'}}>
                            <button className="btn btn-success" onClick={exportAudit}>
                                Exportar Excel
                            </button>
                            <button className="btn btn-warning" onClick={clearOldLogs}>
                                Limpiar Antiguos
                            </button>
                        </div>
                    </div>

                    <div style={{
                        background: '#fef3c7',
                        padding: '15px',
                        borderRadius: '8px',
                        marginBottom: '20px',
                        border: '2px solid #f59e0b'
                    }}>
                        <p style={{color: '#92400e', fontWeight: '600', marginBottom: '5px'}}>
                            üîí ACCESO RESTRINGIDO - SOLO GERENCIA PRINCIPAL
                        </p>
                        <p style={{color: '#92400e', fontSize: '13px'}}>
                            Este registro es inmutable y no puede ser alterado por ning√∫n usuario. 
                            Todas las acciones quedan registradas con fecha, hora y responsable.
                        </p>
                    </div>

                    <div className="filters">
                        <div className="filter-group">
                            <label className="form-label">Filtrar por Fecha:</label>
                            <input 
                                type="date" 
                                className="form-input"
                               value={filterDate || ''}
                                onChange={(e) => setFilterDate(e.target.value)}
                            />
                        </div>
                        <div className="filter-group">
                            <label className="form-label">Filtrar por Usuario:</label>
                            <input 
                                type="text" 
                                className="form-input"
                                placeholder="Buscar usuario..."
                                value={filterUser}
                                onChange={(e) => setFilterUser(e.target.value)}
                            />
                        </div>
                        <div className="filter-group">
                            <label className="form-label">Filtrar por Acci√≥n:</label>
                            <select 
                                className="form-select"
                                value={filterAction}
                                onChange={(e) => setFilterAction(e.target.value)}
                            >
                                <option value="">Todas las acciones</option>
                                {actionTypes.map(action => (
                                    <option key={action} value={action}>{action}</option>
                                ))}
                            </select>
                        </div>
                    </div>

                    <div className="stats-grid" style={{marginBottom: '20px'}}>
                        <div className="stat-card">
                            <div className="stat-value">{filteredLogs.length}</div>
                            <div className="stat-label">Registros Mostrados</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">{auditLogs.length}</div>
                            <div className="stat-label">Total Registros</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">
                                {[...new Set(filteredLogs.map(log => log.usuario))].length}
                            </div>
                            <div className="stat-label">Usuarios Activos</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">
                                {filteredLogs.filter(log => {
                                    const today = new Date();
                                    today.setHours(0, 0, 0, 0);
                                    return new Date(log.timestamp) >= today;
                                }).length}
                            </div>
                            <div className="stat-label">Acciones Hoy</div>
                        </div>
                    </div>

                    <div className="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Fecha/Hora</th>
                                    <th>Usuario</th>
                                    <th>Nombre Completo</th>
                                    <th>Acci√≥n</th>
                                    <th>Detalles</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredLogs.slice().reverse().map(log => (
                                    <tr key={log.id}>
                                        <td style={{fontSize: '11px', color: '#9ca3af'}}>{log.id}</td>
                                        <td style={{whiteSpace: 'nowrap'}}>
                                            {new Date(log.timestamp).toLocaleString('es-ES')}
                                        </td>
                                        <td>
                                            <span className="status-badge status-active">
                                                {log.usuario}
                                            </span>
                                        </td>
                                        <td>{log.nombre}</td>
                                        <td>
                                            <span className={`status-badge ${
                                                log.accion === 'LOGIN' ? 'status-active' :
                                                log.accion === 'FICHAJE' ? 'status-working' :
                                                'status-inactive'
                                            }`}>
                                                {log.accion}
                                            </span>
                                        </td>
                                        <td style={{fontSize: '13px'}}>{log.detalles}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {filteredLogs.length === 0 && (
                        <div className="empty-state">
                            <div className="empty-state-icon">üìã</div>
                            <p>No hay registros que coincidan con los filtros</p>
                        </div>
                    )}
                </div>
            );
        };

        // Componente Principal
        const App = () => {
            const { t, language, changeLanguage } = useTranslation();
            const [currentUser, setCurrentUser] = useState(null);
            const [clockings, setClockings] = useState([]);
            const [absences, setAbsences] = useState([]);
            const [workers, setWorkers] = useState([]);
            const [notification, setNotification] = useState(null);
            const [activeTab, setActiveTab] = useState('clock');

            useEffect(() => {
                // Cargar datos desde Supabase
                const loadDataFromSupabase = async () => {
                    try {
                        // Cargar trabajadores desde Supabase
                        const workersResult = await supabase.from('workers').insert(worker);
                        if (workersResult.data && workersResult.data.length > 0) {
                            const formattedWorkers = workersResult.data.map(w => ({
                                id: w.id,
                                nombre: w.nombre,
                                usuario: w.usuario,
                                password: w.password
                            }));
                            setWorkers(formattedWorkers);
                            console.log('‚úÖ Trabajadores cargados desde Supabase:', formattedWorkers.length);
                        } else {
                            // Fallback a datos locales si Supabase falla
                            setWorkers(COMPANY_DATA.trabajadores);
                            console.log('‚ö†Ô∏è Usando trabajadores locales (Supabase vac√≠o)');
                        }
                        
                        // Cargar fichajes desde Supabase
                        const clockingsResult = await supabase.from('clockings').select('*');

                        if (clockingsResult.data && clockingsResult.data.length > 0) {
                            // Convertir formato Supabase a formato local
                            const formattedClockings = await Promise.all(clockingsResult.data.map(async (c) => {
                                // Buscar nombre del trabajador
                                const worker = formattedWorkers.find(w => w.id === c.worker_id);
                                
                                // Buscar nombre de la obra
                                let worksiteName = 'Desconocida';
                                try {
                                    const worksiteResult =await supabase.from('worksites').select('*').eq('id', c.worksite_id);

                                    if (worksiteResult.data && worksiteResult.data.length > 0) {
                                        worksiteName = worksiteResult.data[0].nombre;
                                    }
                                } catch (err) {
                                    console.warn('Error cargando nombre obra:', err);
                                }
                                
                                location: {
                                        lat: c.worker_lat,
                                        lng: c.worker_lng
                                    },
                                    distance: c.distancia_metros,
                                    gpsValid: c.dentro_rango,
                                    faceRecognized: false,
                                    photo: null
                                };
                            }));
                            setClockings(formattedClockings);
                            console.log('‚úÖ Fichajes cargados desde Supabase:', formattedClockings.length);
                        } else {
                            console.log('‚ÑπÔ∏è No hay fichajes en Supabase');
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Error cargando desde Supabase:', error);
                        // Fallback a localStorage
                        const savedClockings = localStorage.getItem('clockings_v2');
                        const savedUsers = localStorage.getItem('app_users');
                        
                        if (savedClockings) setClockings(JSON.parse(savedClockings));
                        if (savedUsers) {
                            setWorkers(JSON.parse(savedUsers));
                        } else {
                            setWorkers(COMPANY_DATA.trabajadores);
                        }
                    }
                };
                
                loadDataFromSupabase();
                
                // Cargar ausencias (siguen en localStorage por ahora)
                const savedAbsences = localStorage.getItem('absences_v2');
                if (savedAbsences) setAbsences(JSON.parse(savedAbsences));
            }, []);

            // Recargar workers cuando cambien en localStorage
            useEffect(() => {
                const handleStorageChange = () => {
                    const savedUsers = localStorage.getItem('app_users');
                    if (savedUsers) {
                        setWorkers(JSON.parse(savedUsers));
                    }
                };
                
                window.addEventListener('storage', handleStorageChange);
                
                // Tambi√©n verificar cada 5 segundos por si cambi√≥ en la misma pesta√±a
                const interval = setInterval(() => {
                    const savedUsers = localStorage.getItem('app_users');
                    if (savedUsers) {
                        const newWorkers = JSON.parse(savedUsers);
                        setWorkers(prev => {
                            if (JSON.stringify(prev) !== JSON.stringify(newWorkers)) {
                                return newWorkers;
                            }
                            return prev;
                        });
                    }
                }, 5000);
                
                return () => {
                    window.removeEventListener('storage', handleStorageChange);
                    clearInterval(interval);
                };
            }, []);

            useEffect(() => {
                if (clockings.length > 0) {
                    localStorage.setItem('clockings_v2', JSON.stringify(clockings));
                }
            }, [clockings]);

            useEffect(() => {
                localStorage.setItem('absences_v2', JSON.stringify(absences));
            }, [absences]);

            const handleLogin = (user) => {
                setCurrentUser(user);
                
                // Registrar auditor√≠a de ingreso
                const auditLog = {
                    id: Date.now(),
                    usuario: user.usuario,
                    nombre: user.name,
                    accion: 'LOGIN',
                    timestamp: new Date(),
                    ip: 'N/A', // En producci√≥n se obtendr√≠a del servidor
                    detalles: 'Inicio de sesi√≥n exitoso'
                };
                
                const savedAudit = localStorage.getItem('audit_log') || '[]';
                const auditArray = JSON.parse(savedAudit);
                auditArray.push(auditLog);
                localStorage.setItem('audit_log', JSON.stringify(auditArray));
                
                showNotification(`Bienvenido, ${user.name}`, 'success');
            };

            const handleLogout = () => {
                setCurrentUser(null);
                setActiveTab('clock');
                showNotification('Sesi√≥n cerrada', 'success');
            };

            const handleClocking = async (clocking) => {
                // Guardar en Supabase
                try {
                    // Buscar el ID de la obra en Supabase por nombre
                    let worksiteIdNumeric = null;
                    
                    try {
                        const worksitesResult = await supabase.from('worksites').select('*');

                        if (worksitesResult.data && worksitesResult.data.length > 0) {
                            const worksite = worksitesResult.data.find(w => w.nombre === clocking.worksiteName);
                            if (worksite) {
                                worksiteIdNumeric = worksite.id;
                                console.log(`üìç Obra encontrada en Supabase: ${clocking.worksiteName} ‚Üí ID: ${worksiteIdNumeric}`);
                            } else {
                                console.warn(`‚ö†Ô∏è Obra "${clocking.worksiteName}" no encontrada en Supabase`);
                            }
                        }
                    } catch (err) {
                        console.error('Error buscando obra en Supabase:', err);
                    }
                    
                    const supabaseData = {
                        worker_id: clocking.userId,  // userId es el workerId
                        worksite_id: worksiteIdNumeric,  // ID num√©rico de la obra en Supabase
                        tipo: clocking.type === 'in' ? 'entrada' : 'salida',
                        worker_lat: clocking.location?.lat || null,
                        worker_lng: clocking.location?.lng || null,
                        worksite_lat: null,
                        worksite_lng: null,
                        distancia_metros: clocking.distance || null,
                        dentro_rango: clocking.gpsValid || false,
                        estado: clocking.gpsValid ? 'aprobado' : 'revision_manual',
                        device_info: navigator.userAgent
                    };
                    
                    console.log('üì§ Enviando a Supabase:', supabaseData);
                    
                    const result = await supabase.from('clockings').insert(supabaseData);
                    
                    if (result.error) {
                        console.error('‚ùå Error guardando en Supabase:', result.error);
                        // Fallback a localStorage si Supabase falla
                        setClockings([...clockings, clocking]);
                    } else {
                        console.log('‚úÖ Fichaje guardado en Supabase:', result.data);
                        setClockings([...clockings, clocking]);
                    }
                } catch (error) {
                    console.error('‚ùå Error en handleClocking:', error);
                    // Fallback a localStorage
                    setClockings([...clockings, clocking]);
                }
                
                // Auditor√≠a
                logAudit('FICHAJE', `${clocking.type === 'in' ? 'Entrada' : 'Salida'} registrada - Obra: ${clocking.worksiteName}`);
                
                showNotification(
                    `${clocking.type === 'in' ? 'Entrada' : 'Salida'} registrada con √©xito`,
                    'success'
                );
            };

            const logAudit = (accion, detalles) => {
                const auditLog = {
                    id: Date.now(),
                    usuario: currentUser.usuario,
                    nombre: currentUser.name,
                    accion: accion,
                    timestamp: new Date(),
                    detalles: detalles
                };
                
                const savedAudit = localStorage.getItem('audit_log') || '[]';
                const auditArray = JSON.parse(savedAudit);
                auditArray.push(auditLog);
                localStorage.setItem('audit_log', JSON.stringify(auditArray));
            };

            const showNotification = (message, type) => {
                setNotification({ message, type });
            };

            if (!currentUser) {
                return <LoginPage onLogin={handleLogin} />;
            }

            return (
                <div className="container">
                    {notification && (
                        <Notification 
                            message={notification.message}
                            type={notification.type}
                            onClose={() => setNotification(null)}
                        />
                    )}

                    <div className="app-header" style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        padding: '20px 30px'
                    }}>
                        <div style={{display: 'flex', alignItems: 'center', gap: '20px'}}>
                            <div className="app-title">Control de Presencia</div>
                            <div style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)'}}>v18.4</div>
                        </div>
                        
                        <div style={{display: 'flex', alignItems: 'center', gap: '20px'}}>
                            {/* Selector de idiomas - AMBOS VISIBLES */}
                            <div style={{display: 'flex', gap: '10px'}}>
                                <button
                                    onClick={() => changeLanguage('es')}
                                    style={{
                                        background: language === 'es' ? '#10b981' : '#3b82f6',
                                        color: 'white',
                                        border: 'none',
                                        padding: '10px 16px',
                                        borderRadius: '6px',
                                        cursor: 'pointer',
                                        fontSize: '15px',
                                        fontWeight: '600',
                                        transition: 'all 0.2s',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '6px',
                                        boxShadow: '0 2px 4px rgba(0,0,0,0.2)',
                                        transform: language === 'es' ? 'scale(1.05)' : 'scale(1)'
                                    }}
                                >
                                    <span style={{fontSize: '18px'}}>üá™üá∏</span>
                                    <span>ES</span>
                                </button>
                                <button
                                    onClick={() => changeLanguage('pt')}
                                    style={{
                                        background: language === 'pt' ? '#10b981' : '#3b82f6',
                                        color: 'white',
                                        border: 'none',
                                        padding: '10px 16px',
                                        borderRadius: '6px',
                                        cursor: 'pointer',
                                        fontSize: '15px',
                                        fontWeight: '600',
                                        transition: 'all 0.2s',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '6px',
                                        boxShadow: '0 2px 4px rgba(0,0,0,0.2)',
                                        transform: language === 'pt' ? 'scale(1.05)' : 'scale(1)'
                                    }}
                                >
                                    <span style={{fontSize: '18px'}}>üáµüáπ</span>
                                    <span>PT</span>
                                </button>
                            </div>
                            
                            {/* Usuario con ROL */}
                            <div style={{
                                background: 'rgba(255,255,255,0.2)',
                                padding: '10px 18px',
                                borderRadius: '8px',
                                border: '2px solid rgba(255,255,255,0.3)',
                                display: 'flex',
                                flexDirection: 'column',
                                alignItems: 'flex-end',
                                gap: '2px'
                            }}>
                                <div style={{
                                    fontSize: '15px',
                                    fontWeight: '600',
                                    color: 'white'
                                }}>
                                    {currentUser.usuario || currentUser.name}
                                </div>
                                <div style={{
                                    fontSize: '11px',
                                    color: 'rgba(255,255,255,0.8)',
                                    textTransform: 'uppercase',
                                    fontWeight: '500'
                                }}>
                                    {currentUser.name}
                                </div>
                            </div>
                            
                            {/* Bot√≥n Cerrar Sesi√≥n */}
                            <button 
                                className="btn" 
                                onClick={handleLogout}
                                style={{
                                    background: '#ef4444',
                                    color: 'white',
                                    border: 'none',
                                    padding: '10px 20px',
                                    fontSize: '14px',
                                    fontWeight: '600',
                                    borderRadius: '6px',
                                    cursor: 'pointer',
                                    boxShadow: '0 2px 4px rgba(0,0,0,0.2)',
                                    transition: 'all 0.2s'
                                }}
                                onMouseOver={(e) => e.target.style.background = '#dc2626'}
                                onMouseOut={(e) => e.target.style.background = '#ef4444'}
                            >
                                {t('nav_logout')}
                            </button>
                        </div>
                    </div>

                    <div className="tabs">
                        {currentUser.role === 'worker' && (
                            <button 
                                className={`tab ${activeTab === 'clock' ? 'active' : ''}`}
                                onClick={() => setActiveTab('clock')}
                            >
                                {t('nav_clock')}
                            </button>
                        )}
                        {currentUser.role === 'admin' && (
                            <>
                                <button 
                                    className={`tab ${activeTab === 'monitor' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('monitor')}
                                >
                                    {t('nav_monitor')}
                                </button>
                                <button 
                                    className={`tab ${activeTab === 'history' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('history')}
                                >
                                    {t('nav_history')}
                                </button>
                                <button 
                                    className={`tab ${activeTab === 'stats' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('stats')}
                                >
                                    {t('nav_stats')}
                                </button>
                                <button 
                                    className={`tab ${activeTab === 'absences' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('absences')}
                                >
                                    {t('nav_absences')}
                                </button>
                                <button 
                                    className={`tab ${activeTab === 'gps' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('gps')}
                                >
                                    {t('nav_gps')}
                                </button>
                                <button 
                                    className={`tab ${activeTab === 'users' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('users')}
                                >
                                    {t('nav_users')}
                                </button>
                                <button 
                                    className={`tab ${activeTab === 'face-registration' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('face-registration')}
                                >
                                    {t('nav_face')}
                                </button>
                                {currentUser.usuario === 'gerencia' && (
                                    <button 
                                        className={`tab ${activeTab === 'audit' ? 'active' : ''}`}
                                        onClick={() => setActiveTab('audit')}
                                    >
                                        {t('nav_audit')}
                                    </button>
                                )}
                                <button 
                                    className={`tab ${activeTab === 'qr' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('qr')}
                                >
                                    {t('nav_qr')}
                                </button>
                            </>
                        )}
                    </div>

                    {activeTab === 'clock' && currentUser.role === 'worker' && (
                        <WorkerApp 
                            user={currentUser}
                            clockings={clockings}
                            onClocking={handleClocking}
                        />
                    )}

                    {activeTab === 'fichar' && currentUser.role === 'admin' && (
                        <WorkerApp 
                            user={currentUser}
                            clockings={clockings}
                            onClocking={handleClocking}
                        />
                    )}

                    {activeTab === 'monitor' && currentUser.role === 'admin' && (
                        <MonitoringDashboard 
                            clockings={clockings}
                            absences={absences}
                            workers={workers}
                        />
                    )}

                    {activeTab === 'qr' && currentUser.role === 'admin' && (
                        <AdminQRPanel />
                    )}

                    {activeTab === 'history' && currentUser.role === 'admin' && (
                        <AdminHistory clockings={clockings} />
                    )}

                    {activeTab === 'stats' && currentUser.role === 'admin' && (
                        <AdminStats clockings={clockings} workers={workers} absences={absences} />
                    )}

                    {activeTab === 'absences' && currentUser.role === 'admin' && (
                        <AbsenceManagement 
                            absences={absences}
                            onUpdate={setAbsences}
                        />
                    )}

                    {activeTab === 'gps' && currentUser.role === 'admin' && (
                        <GPSManager 
                            showNotification={showNotification}
                        />
                    )}

                    {activeTab === 'users' && currentUser.role === 'admin' && (
                        <UserManagement 
                            showNotification={showNotification}
                        />
                    )}

                    {activeTab === 'face-registration' && currentUser.role === 'admin' && (
                        <FaceRegistration 
                            currentUser={currentUser}
                            showNotification={showNotification}
                        />
                    )}

                    {activeTab === 'audit' && currentUser.role === 'admin' && currentUser.usuario === 'gerencia' && (
                        <AuditLog currentUser={currentUser} />
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
<!-- <script type="module" src="app.js"></script> -->
</script>
</body>
</html>
